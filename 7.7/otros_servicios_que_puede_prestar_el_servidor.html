<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>6. Otros servicios que puede prestar el servidor</title><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><link rel="home" href="index.html" title="La distribución Aprendiendo de Jesús como servidor y cortafuegos"><link rel="up" href="index.html" title="La distribución Aprendiendo de Jesús como servidor y cortafuegos"><link rel="prev" href="protocolos_de_soporte_y_de_usuario.html" title="5. Protocolos de soporte y de usuario"><link rel="next" href="novedades.html" title="A. Novedades"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">6. Otros servicios que puede prestar el servidor</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="protocolos_de_soporte_y_de_usuario.html">Anterior</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="novedades.html">Siguiente</a></td></tr></table><hr></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="otros_servicios_que_puede_prestar_el_servidor"></a>6. Otros servicios que puede prestar el servidor</h2></div></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="cuotas"></a>6.1. Cuotas</h3></div></div></div><p>
      Pueden emplearse cuotas para limitar el espacio en disco y la
      cantidad de archivos que un usuario o un grupo puede tener.
    </p><p>
      Para usarlo debe: (1) especificar sistemas de archivos en los que
      se usará cuota (2) especificar cuota por usuario o grupo y (3)
      activar chequeo de cuota durante el arranque.
    </p><p>
      Indique los sistemas de archivos en los que usará cuota, en
      <code class="literal">/etc/fstab</code> agregando como opción del sistema de
      archivos: <code class="literal">userquota</code> y/o
      <code class="literal">groupquota</code>. Por ejemplo:
    </p><pre class="programlisting">
    /dev/wd0d /home ffs rw,nodev,nosuid,userquota 1 2
</pre><p>
      Después active el sistema de cuotas con:
    </p><pre class="programlisting">
    doas quotaon -a
</pre><p>
      Para especificar la cuota por usuario o por grupo emplee
      <code class="literal">edquota</code>, por ejemplo:
    </p><pre class="programlisting">
    doas edquota pabram
</pre><p>
      que lo dejará en un editor en el que podrá cambiar las
      especificaciones de la cuota en cada sistema de archivos con
      cuotas:
    </p><pre class="programlisting">
    Quotas for user pabram:
    /home: blocks in use: 1292980, limits (soft = 1000000, hard = 2000000)
        inodes in use: 142318, limits (soft = 0, hard = 0)
</pre><p>
      el límite blando podrá extenderse para cada usuario por un periodo
      de tiempo (en este ejemplo), tras el cual se convertirá en un
      límite duro. Límites en 0 indican que no hay restricción.
    </p><p>
      Puede replicar la configuración de cuotas en otros usuarios con:
    </p><pre class="programlisting">
    doas edquota -p pabram pedgar juamar margo
</pre><p>
      Después de especificar las cuotas de los usuarios puede verificar
      la política de cuotas con:
    </p><pre class="programlisting">
    repquota -a
</pre><p>
      o chequear que se cumplan todas las cuotas con:
    </p><pre class="programlisting">
    quotacheck -a
</pre><p>
      Para activar sistema de cuotas y que las cuotas sean verificadas
      cada vez que el sistema inicia agregue la siguiente línea al
      archivo <code class="literal">/etc/rc.conf.local</code>:
    </p><pre class="programlisting">
    check_quotas=YES
</pre><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="referencias-quota"></a>6.1.1. Referencias y lecturas recomendadas</h4></div></div></div><p>
        Las siguientes páginas del manual de OpenBSD: quota 1, edquota
        8, quotaon 8, quotaoff 8, quotacheck 8 y repquota 8. En el FAQ
        de OpenBSD hay una sección sobre quotas:
        <a class="ulink" href="http://www.openbsd.org/faq/faq10.html#Quotas" target="_top">http://www.openbsd.org/faq/faq10.html#Quotas</a>
      </p></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="postgresql"></a>6.2. Motor de bases de datos PostgreSQL</h3></div></div></div><p>
      PostgreSQL es un motor de bases de datos relacionales (RDBMS) que
      verifica integridad referencial con gran funcionalidad como base
      de datos, aunque un poco más lenta que otros motores. Su licencia
      es tipo BSD. En esta sección describimos brevemente la instalación
      y uso en un sistema adJ.
    </p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="primera-instalacion"></a>6.2.1. Primera instalación del servidor</h4></div></div></div><p>
        Este motor de bases de datos se instala con el archivo de
        órdenes <code class="literal">/inst-adJ.sh</code> que en instalaciones
        típicas de adJ basta ejecutar y volver a ejecutar para
        actualizar o para volver a inicializar PostgreSQL u otro paquete
        de esta distribución. En caso de actualizar este archivo sacará
        respaldo de la información de la base de 2 formas (copiando
        directorios de PostgreSQL y sacando un volcado de toda la base).
      </p><p>
        A continuación se dan detalles del proceso de instalación y uso
        de PostgreSQL en caso de que requiera instalar por su cuenta o
        aprender más sobre este motor de bases de datos.
      </p><p>
        Para emplearlo por primera vez instale el paquete
        <code class="literal">postgresql-server</code> (también es recomendable
        <code class="literal">postgresql-docs</code>).
      </p><p>
        Este paquete deja instrucciones específicas para inicializar la
        base de datos, permitir conexiones de red e inicializar la base
        de datos cada vez que arranque el sistema en:
        <code class="literal">/usr/local/share/doc/postgresql/README.OpenBSD</code>.
        Los pasos que este escrito describe son:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            Opcional. El paquete de PostgreSQL disponible crea el
            usuario del sistema <code class="literal">_postgresql</code>, sin
            embargo si está actualizando o lo requiere puede crearlo
            con:
          </p><pre class="programlisting">
    doas useradd -c "Administrador de PostgreSQL" -g =uid -m -d /var/postgresql \
    -s /bin/sh -u 503 _postgresql
    doas passwd _postgresql
</pre></li><li class="listitem"><p>
            A diferencia de versiones anteriores, este paquete ya no
            inicializa la base. Inicialícela con:
          </p><pre class="programlisting">
    doas mkdir -p /var/postgresql/data
    doas chown -R _postgresql:_postgresql /var/postgresql
    doas su - _postgresql
    initdb --auth=md5 -D /var/postgresql/data -U postgres --encoding=UTF8
</pre><p>
            En adJ se emplea por defecto autenticación md5, que requiere
            suministrar clave cada vez que se carga la interfaz
            <code class="literal">psql</code> o abre conexiones. Si no desea
            autenticación md5, al inicializar la base con
            <code class="literal">initdb</code> emplee la opción
            <code class="literal">--auth=trust</code>. Una vez inicializada puede
            cambiar de un método a otro en el archivo
            <code class="literal">/var/postgresql/data/pg_hba.conf</code>
          </p></li><li class="listitem"><p>
            Altamente Recomendado. Agregue a
            <code class="literal">/etc/sysctl.conf</code>:
          </p><pre class="programlisting">
    kern.seminfo.semmni=256
    kern.seminfo.semmns=2048
    kern.shminfo.shmmax=50331648
</pre></li><li class="listitem"><p>
            Configurar servicio para que inicie en el arranque y se
            detenga al apagar. En <code class="literal">/etc/rc.conf.local</code>
            agregue:
          </p><pre class="programlisting">
    pg_ctl_flags="start \
        -D /var/postgresql/data -l /var/postgresql/logfile \
        -o '-D /var/postgresql/data'"
</pre><p>
            y en el mismo archivo en la línea donde se define
            <code class="literal">pkg_scripts</code> agregue postgresql, así un
            computador donde estén configuradas las particiones
            cifradas, respaldo cifrado y los servicios httpd, cupsd
            dirá:
          </p><pre class="programlisting">
    pkg_scripts="cron montaencres montaencpos postgresql httpd cupsd"
</pre></li></ul></div><p>
        Inicialmente el servidor queda configurado con un zócalo
        (socket) Unix (solo desde la misma máquina). Puede comprobar que
        está corriendo el servidor (postmaster) con:
      </p><pre class="programlisting">
    pgrep post
</pre><p>
        y revisar el zócalo examinando la presencia del archivo
        <code class="literal">/var/www/var/run/postgresql/.s.PGSQL.5432</code>
        (otra ubicación más común pero fuera de la jaula chroot para
        servidores web es <code class="literal">/tmp/.s.PGSQL.5432</code>).
      </p><p>
        Para emplear el protocolo TCP/IP para conexiones desde algunas
        máquinas de su elección, edite
        <code class="literal">/var/postgresql/data/pg_hba.conf</code> y agregue
        por ejemplo máquinas y usuarios que puedan hacer conexiones.
        También edite
        <code class="literal">/var/postgresql/data/postgresql.conf</code> para que
        incluya líneas de configuración como:
      </p><pre class="programlisting">
    max_connections = 100
    port = 5432
</pre><p>
        Para mejorar desempeño especialmente en sitios que atiendan
        bastantes conexiones simultáneamente, consulte primero
        <code class="literal">/usr/local/share/doc/postgresql/README.OpenBSD</code>.
      </p><p>
        En adJ por seguridad (e.g cuando ejecuta nginx con
        <code class="literal">chroot</code> en <code class="literal">/var/www</code>) no se
        permiten conexiones TCP/IP y se emplea una ruta para los zócalos
        diferente a la ruta por defecto (i.e <code class="literal">/tmp</code>),
        se trata de <code class="literal">/var/www/var/run/postgresql</code>, que
        se define en el archivo de configuración de PostgreSQL con:
      </p><pre class="programlisting">
    unix_socket_directories = '/var/www/var/run/postgresql'
</pre><p>
        Antes de reiniciar PostgreSQL asegúrese de crear el directorio:
      </p><pre class="programlisting">
    doas mkdir  /var/www/var/run/postgresql
    doas chmod a+w /var/www/var/run/postgresql
    doas chmod +t /var/www/var/run/postgresql
</pre><p>
        También tenga en cuenta que las diversas herramientas reciben
        como parámetro adicional <code class="literal">-h ruta</code>. Por ejemplo
        si ejecuta nginx con <code class="literal">chroot</code> en
        <code class="literal">/var/www/</code> puede tener configurado su
        directorio para zócalos en
        <code class="literal">/var/www/var/run/postgresql</code>, en ese caso
        puede iniciar <code class="literal">psql</code> con la base
        <code class="literal">prueba</code> usando:
      </p><pre class="programlisting">
    psql -h /var/www/var/run/postgresql prueba
</pre><p>
        En paquetes anteriores al de adJ 4.1 el superusuario de la base
        coincidía con el usuario del sistema
        <code class="literal">_postgresql</code>, desde 4.1 el superusuario de la
        base es <code class="literal">postgres</code>, así que para realizar
        operaciones debe agregar la opción
        <code class="literal">-U postgres</code>. El instalador de adJ
        seleccionará una clave con el programa <code class="literal">apg</code> y
        la dejará en el archivo
        <code class="literal">/var/postgresql/.pgpass</code> en una línea de la
        forma:
      </p><pre class="programlisting">
    *:*:*:postgres:clave
</pre><p>
        De esta manera desde la cuenta <code class="literal">_postgresql</code> no
        necesitará dar la clave del usuario <code class="literal">postgres</code>.
      </p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="autenticacion"></a>6.2.2. Habilitando autenticación</h4></div></div></div><p>
        Por defecto la forma de inicializar PostgreSQL no establecerá
        una clave de administrador ni exigirá autenticación para cuentas
        que se conecten desde la misma máquina. Sin embargo esto debe
        mejorarse si tiene varias cuentas en el mismo servidor.
      </p><p>
        Una manera es en el momento de la inicialización de la base de
        datos con las opciones <code class="literal">--auth</code> y
        <code class="literal">--pwfile</code> o <code class="literal">-W</code> de
        <code class="literal">initdb</code>, por ejemplo:
      </p><pre class="programlisting">
    su - _postgresql
    echo "MiClave" &gt; clave.txt
    initdb -Upostgres --auth=md5 --pwfile=clave.txt -D/var/postgresql/data
</pre><p>
        que inicializará PostgreSQL con autenticación md5 y clave de
        administrador <code class="literal">MiClave</code>
      </p><p>
        Otra posibilidad es cambiar la configuración después de haber
        inicializado sin autenticación. Para esto cambie la clave del
        administrador con<a href="#ftn.id2891" class="footnote" name="id2891"><sup class="footnote">[29]</sup></a>:
      </p><pre class="programlisting">
    psql -h /var/www/var/run/postgresql -U postgres template1
    template1=# alter user postgres with password 'MiClave';
</pre><p>
        Después edite
        <code class="literal">/var/postgresql/data/pg_hba.conf</code> y cambie en
        las lineas de acceso la palabra <code class="literal">trusted</code> por
        <code class="literal">md5</code>, por ejemplo:
      </p><pre class="programlisting">
    local   all         all                               md5
    host    all         all         127.0.0.1/32          md5
    host    all         all         ::1/128               md5
</pre><p>
        Detenga el servidor y vuélvalo a iniciar, notará que todo
        intento de ingreso exige la clave.
      </p><p>
        El listado de bases de datos puede consultarse con:
      </p><pre class="programlisting">
    SELECT * FROM pg_database ;
</pre><p>
        y el listado de los usuarios con:
      </p><pre class="programlisting">
    SELECT username FROM pg_users;
</pre><p>
        Las claves de los diversos usuarios pueden cambiarse de forma
        análoga a la presentada para <code class="literal">postgres</code>:
      </p><pre class="programlisting">
    ALTER ROLE pablo with UNENCRYPTED PASSWORD 'clave-plana';
</pre><p>
        Desde PostgreSQL 8.1 se emplea un esquema de roles que unifica
        los conceptos de usuario y grupo. Además de exigir clave para
        cada ingreso, cada rol de PostgreSQL que crea objetos puede
        modificar permisos para restringir o dar acceso a otros roles.
        Por ejemplo para restringir el acceso a una tabla
        <code class="literal">cuenta</code>:
      </p><pre class="programlisting">
    REVOKE ALL ON cuenta FROM PUBLIC;
</pre><p>
        Cuando un rol crea una base de datos, queda como dueño de todas
        las tablas y en principio es el único que puede acceder a estas.
        Otro rol en principio no podrá ni siquiera examinar los datos de
        las tablas:
      </p><pre class="programlisting">
    SELECT * FROM solicitud;
    ERROR:  permission denied for relation solicitud
</pre><p>
        Para dar permiso a otro rol puede usarse:
      </p><pre class="programlisting">
    GRANT ALL on solicitud TO rodrigo;
</pre></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="creacion-base"></a>6.2.3. Creación de una base de datos</h4></div></div></div><p>
        Para crear la base de datos <code class="literal">prueba</code> puede usar
        el superusuario con la opción <code class="literal">-U postgres</code> o
        desde una cuenta que tenga permiso para crear bases de datos:
      </p><pre class="programlisting">
    createdb -h /var/www/var/run/postgresql -U postgres prueba
    psql -h /var/www/var/run/postgresql -U postgres prueba
</pre><p>
        Desde la interfaz <code class="literal">psql</code>, pueden darse órdenes
        SQL y otros específicos de PostgreSQL (ver
        <a class="link" href="otros_servicios_que_puede_prestar_el_servidor.html#uso-base" title="6.2.4. Uso de una base de datos">Uso de una base de datos</a>). En
        particular el usuario <code class="literal">postgres</code> y desde
        cuentas con permiso para crear usuarios, puede crear otros
        usuarios (globales para todas las bases de datos manejadas por
        el servidor). Por ejemplo para crear un usuario normal sin
        clave, desde <code class="literal">psql</code> ingresar:
      </p><pre class="programlisting">
    CREATE USER usejemplo
</pre><p>
        La orden <code class="literal">CREATE USER</code> presentado puede ir
        seguido de <code class="literal">CREATEUSER</code> para crear un
        superusuario (sin restricción alguna), o
        <code class="literal">CREATEDB</code> para crear un usuario que pueda
        crear bases de datos o <code class="literal">PASSWORD 'clave'</code> para
        crear un usuario con una clave (emplea autenticación
        configurada). Desde la línea de órdenes puede crearse un usuario
        con:
      </p><pre class="programlisting">
    createuser -h /var/www/var/run/postgresql -U postgres  usejemplo
</pre><p>
        Para eliminar un usuario desde <code class="literal">psql</code> se usa:
      </p><pre class="programlisting">
    DROP USER usejemplo;
</pre><p>
        y para eliminarlo desde línea de órdenes:
      </p><pre class="programlisting">
    dropuser -h /var/www/var/run/postgresql -U postgres usejemplo
</pre><p>
        Puede ejecutarse un script SQL (<code class="literal">crea.sql</code>)
        desde la línea de órdenes a un base de datos con
      </p><pre class="programlisting">
    psql -h /var/www/var/run/postgresql -d test -U ejusuario --password -f crea.sql
</pre></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="uso-base"></a>6.2.4. Uso de una base de datos</h4></div></div></div><p>
        Puede emplear <code class="literal">psql</code>, la interfaz texto que
        acepta órdenes SQL y que se distribuye con PostgreSQL. Para
        esto, entre a una base (digamos <code class="literal">b1908</code>) como
        un usuario (digamos <code class="literal">u1908</code>) con:
      </p><pre class="programlisting">
    psql -h /var/www/var/run/postgresql  -U u1908 -d b1908
</pre><p>
        En esta interfaz puede dar órdenes SQL y algunas órdenes
        internos que puede listar con <code class="literal">\h</code>. Algunos
        ejemplos de operaciones útiles son:
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
            <code class="literal">\dt</code>
          </span></dt><dd><p>
              para ver tablas disponibles.
            </p></dd><dt><span class="term">
            <code class="literal">\d usuarios</code>
          </span></dt><dd><p>
              Describe la estructura de la tabla
              <code class="literal">usuarios</code>
            </p></dd><dt><span class="term">
            <code class="literal">SELECT victim_nombre,victim_apellido FROM victimas WHERE victim_edad&lt;=12;</code>
          </span></dt><dd><p>
              Que muestre los nombres de niños de 12 años o menos
              listados en la tabla <code class="literal">victimas</code>
            </p></dd><dt><span class="term">
            <code class="literal">\h update</code>
          </span></dt><dd><p>
              Da ayuda sobre la orden <code class="literal">update</code> (que
              permite actualizar registros de una tabla.)
            </p></dd></dl></div><p>
        Es recomendable que los usuarios del sistema que también son
        usuarios de PostgreSQL creen el archivo
        <code class="literal">~/.pgpass</code> donde puede almacenarse la clave
        que usa en PostgreSQL —de forma que las diversas herramientas no
        la solicitaran— con una línea de la forma:
      </p><pre class="programlisting">
    *:*:*:usuario:clave
</pre></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="postgresql-cotejacion"></a>6.2.5. Cotejación en PostgreSQL</h4></div></div></div><p>
        Desde adJ 5.2 se incluye un porte de PostgreSQL (la versión
        incluida en adJ 7.7 es postgresql-server-17.5) que
        soporta cotejaciones de acuerdo al locale, y por defecto se
        crean cotejaciones para todos los países de habla hispana, con
        nombres de la forma <code class="literal">es_CO_UTF_8</code>. Donde
        <code class="literal">CO</code> representa Colombia, pero se pueden
        emplear otras abreviaturas de países como se usan en Internet
        (estándar ISO-3166-1): ES CO PE VE EC GT CU BO HN PY SV CR PA GQ
        MX AR CH DO NI UY PR.
      </p><p>
        Puede examinar las cotejaciones disponibles ingresando al
        interprete <code class="literal">psql</code> y ejecutando:
      </p><pre class="programlisting">
    SELECT * FROM pg_collation;
</pre><p>
        Puede crear una cotejación (digamos <code class="literal">esp</code>) para
        un locale soportado por el sistema operativo y con la misma
        codificación de su base de datos (digamos
        <code class="literal">es_CO.ISO8859-1</code>) con:
      </p><pre class="programlisting">
    CREATE COLLATION esp (LOCALE='es_CO.ISO8859-1');
</pre><p>
        Una vez creada puede realizar operaciones empleándola por
        ejemplo:
      </p><pre class="programlisting">
    SELECT 'Á' &lt; 'B' COLLATE "esp";
    ...
    SELECT nombre FROM clase ORDER BY nombre COLLATE "esp";
</pre><p>
        la primera sentencia dará:
      </p><pre class="programlisting">
    ?column?
    ----------
    t
    (1 row)
</pre><p>
        Puede crear columnas de tablas especificando el tipo de
        cotejación por defecto para operaciones con esa columna.
      </p><pre class="programlisting">
    CREATE TABLE ejc (
    nombre VARCHAR(100) COLLATE "esp"
    );
</pre><p>
        o cambiar las existentes:
      </p><pre class="programlisting">
    ALTER TABLE clase ALTER nombre TYPE VARCHAR(500) COLLATE "esp";
</pre><p>
        También podrá renombrar cotejaciones que haya creado con
        <code class="literal">ALTER COLLATION esp RENAME TO es_CO_ISO8859_1;</code>,
        así como borrarlas con <code class="literal">DROP COLLATION esp;</code>.
        Puede consultar más en
        <a class="ulink" href="http://www.postgresql.org/docs/9.1/static/collation.html" target="_top">http://www.postgresql.org/docs/9.1/static/collation.html</a>.
      </p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="respaldo-postgresql"></a>6.2.6. Copias de respaldo</h4></div></div></div><p>
        Para sacar una copia de respaldo de todas las base de datos
        manejadas con PostgreSQL (y suponiendo que el zócalo está en
        <code class="literal">/var/www/var/run/postgresql</code>): ingrese a la
        cuenta del administrador:
      </p><pre class="programlisting">
    doas su - _postgresql
    pg_dumpall -U postgres -h /var/www/var/run/postgresql/ \
        --inserts --attribute-inserts &gt; /respaldos/pgdump.sql
</pre><p>
        Puede restablecer una copia con
      </p><pre class="programlisting">
    psql -U postgres -h /var/www/var/run/postgresql/ \
        -f /respaldos/pgdump.sql template1
</pre><p>
        Para actualizar PostgreSQL estos procedimientos son el método
        demorado pero seguro:
      </p><div class="orderedlist"><ol class="orderedlist compact" type="1"><li class="listitem"><p>
            Sacar una copia de respaldo antes de actualizar
          </p></li><li class="listitem"><p>
            Actualizar PostgreSQL
          </p></li><li class="listitem"><p>
            Restaurar el respaldo
          </p></li></ol></div><p>
        Sin embargo en ocasiones funciona un método rápido con
        <code class="literal">pg_upgrade</code> que se presenta en la siguiente
        sección.
      </p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="pg-upgrade"></a>6.2.7. Actualización con <code class="literal">pg_upgrade</code></h4></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
            Saca los respaldos típicos antes de comenzar la
            actualización con: 7.7-amd64/util/preact.sh
          </p></li><li class="listitem"><p>
            <code class="literal">pg_upgrade</code> no operará bien con PostGIS,
            por eso si has usado esa extensión en alguna base de datos
            es mejor quitarla antes de actualizar y volver a agregarla
            después de actualizar. Si tienes muchas bases de datos,
            desde el usuario <code class="literal">_postgresql</code> puedes crear
            un par de guiones para el interprete de ordenes, uno que la
            quite PostGIS de las bases donde este (digamos
            <code class="literal">/var/www/tmp/quita-postgis.sh</code>) y otro que
            la vuelva a poner en esas mismas bases (digamos
            <code class="literal">/var/www/tmp/agrega-postgis.sh</code>). Para
            generar ambos guiones adJ incluye un guión en el que te
            puedes basar para tu caso. Ejecútalo con<a href="#ftn.id3029" class="footnote" name="id3029"><sup class="footnote">[30]</sup></a>
          </p><pre class="programlisting">
 /usr/local/adJ/pg_preact_postgis.sh
</pre><p>
            Después ejecuta el guión creado que quita extensiones:
          </p><pre class="programlisting">
/var/www/tmp/quita-postgis.sh
</pre></li></ol></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem" value="3"><p>
            Actualiza adJ con el procedimiento normal, primero sistema
            base después el resto con <code class="literal">/inst-adJ.sh</code>,
            pero detenlo cuando pregunte
            <code class="literal">Desea eliminar la actual versión de PostgreSQL</code>
          </p></li><li class="listitem"><p>
            Detén la base anterior:
          </p><pre class="programlisting">
doas rcctl stop postgresql
</pre><p>
            y mueve directorio con datos de PostgreSQL 15
          </p><pre class="programlisting">
doas mv /var/postgresql/data /var/postgresql/data-15
</pre></li><li class="listitem"><p>
            Desinstala los paquetes de <code class="literal">postgresql</code>
            anteriores. Puedes hacerlo con la siguiente orden y
            confirmando que elimine todos los dependientes:
          </p><pre class="programlisting">
doas pkg_delete postgresql-client postgresql-docs postgresql-previous
</pre></li><li class="listitem"><p>
            Instala los paquetes <code class="literal">postgresql-client</code>,
            <code class="literal">postgresql-server</code>,
            <code class="literal">postgresql-contrib</code>,
            <code class="literal">postgresql-previous</code> y
            <code class="literal">postgresql-pg_upgrade</code> (inicialmente no
            instales <code class="literal">postgresql-docs</code> porque tiene
            conflicto con <code class="literal">postgresql-previous</code>).
          </p><pre class="programlisting">
cd 7.7-amd64/paquetes
PKG_PATH=. doas pkg_add ./xz-* ./icu4c-* ./libxml* ./postgresql-server-* \
       ./postgresql-contrib-* postgresql-previous-* \
       ./postgresql-pg_up*
</pre><p>
            (Si estás corriendo una versión de adJ anterior a la 6.6
            puedes encontrar los paquetes
            <code class="literal">postgresql-previous</code> y
            <code class="literal">postgresql-pg_upgrade</code> en
            <a class="ulink" href="http://adj.pasosdejesus.org/pub/AprendiendoDeJesus/" target="_top">http://adj.pasosdejesus.org/pub/AprendiendoDeJesus/</a>
            en un directorio de la forma <code class="literal">6.5-extra</code>.
            Como no están firmados al momento de instalarlos con
            <code class="literal">pkg_add</code> usa la opción
            <code class="literal">-D unsigned</code>).
          </p></li><li class="listitem"><p>
            Inicializa un nueva base en
            <code class="literal">/var/postgresql/data</code> con la clave de
            administrador de la anterior (suponiendo que está en el
            archivo <code class="literal">.pgpass</code> de la cuenta
            <code class="literal">_postgresql</code> como ocurre por omisión en
            adJ) con:
          </p><pre class="programlisting">
doas su - _postgresql
grep postgres .pgpass |  sed  -e  "s/.*://g" &gt; /tmp/clave.txt
LANG=C.UTF-8 initdb --encoding=UTF-8 -U postgres --auth=md5 \
   --pwfile=/tmp/clave.txt  -D/var/postgresql/data
</pre></li><li class="listitem"><p>
            Durante la actualización mantén la configuración por omisión
            (no muevas zócalos
            –<span class="strong"><strong>sockets</strong></span>) y edita y
            cambia <code class="literal">pg_hba.conf</code> de
            <code class="literal">data</code> y de <code class="literal">data-15</code>
          </p><pre class="programlisting">
$EDITOR /var/postgresql/data/pg_hba.conf /var/postgresql/data-15/pg_hba.conf
</pre><p>
            temporalmente a un modo inseguro, remplazando
          </p><pre class="programlisting">
local all all md5
</pre><p>
            por
          </p><pre class="programlisting">
local all all trust
</pre></li><li class="listitem"><p>
            Inicia la restauración así:
          </p><pre class="programlisting">
doas su - _postgresql
pg_upgrade -b /usr/local/bin/postgresql-15/ -B /usr/local/bin \
   -U postgres -d /var/postgresql/data-15/ -D /var/postgresql/data
</pre><p>
            Si llega a fallar con un mensaje de error del estilo:
          </p><pre class="programlisting">
Checking for presence of required libraries fatal
Your installation references loadable libraries ...
</pre><p>
            Seguramente te faltó instalar
            <code class="literal">postgresql-contrib</code> que incluye
            <code class="literal">accent</code> y otros módulos. Instala y repite.
          </p><p>
            Si falla con un error como
          </p><pre class="programlisting">
*failure*
Consult the last few lines of "pg_upgrade_dump_32486425.log"
</pre><p>
            y al consultar las últimas líneas del archivo indicado se ve
          </p><pre class="programlisting">
pg_dump: error: query failed: ERROR:  could not access file "$libdir/postgis-3"
</pre><p>
            debes quitar la extensión postgis en las bases del cluster
            anterior con:
          </p><pre class="programlisting">
DROP EXTENSION postgis;
</pre><p>
            (mejor como se indicó en el paso 2) y volver a agregarlo
            después de completar la actualización.
          </p></li><li class="listitem"><p>
            Arranca la nueva base con la configuración por omisión de
            manera temporal con
          </p><pre class="programlisting">
doas rcctl start postgresql
</pre></li><li class="listitem"><p>
            Asegura la clave, revisándola con
            <code class="literal">cat /tmp/clave.txt</code> y estableciendola con:
          </p><pre class="programlisting">
psql -U postgres template1
ALTER USER postgres WITH PASSWORD 'nuevaaqui';
</pre><p>
            después elimina el archivo
            <code class="literal">rm /tmp/clave.txt</code>
          </p></li><li class="listitem"><p>
            Compara cambios en configuración entre versión anterior y
            actual:
          </p><pre class="programlisting">
doas diff /var/postgresql/data-15/postgresql.conf /var/postgresql/data/postgresql.conf
</pre><p>
            Y simultaneamente edita
            <code class="literal">/var/postgresql/data/postgresql.conf</code> para
            aplicar los cambios necesarios. Por lo menos memoria de
            trabajo y la ubicación del socket (puede haber otros
            particulares de tu instalación e.g conexiones TCP, llaves,
            etc).
          </p><pre class="programlisting">
work_mem = 128MB
...
unix_socket_directories = '/var/www/var/run/postgresql'
</pre><p>
            Edita <code class="literal">data/pg_hba.conf</code> para volver a
            dejar <code class="literal">md5</code> en lugar de
            <code class="literal">trust</code>
          </p></li><li class="listitem"><p>
            Si los pasos anteriores han sido exitosos puedes eliminar el
            cluster anterior con
          </p><pre class="programlisting">
./delete_old_cluster.sh
</pre><p>
            y puedes optimizar nuevo cluster con
          </p><pre class="programlisting">
/usr/local/bin/vacuumdb -U postgres --all --analyze-in-stages
</pre></li><li class="listitem"><p>
            Detén nuevamente el servicio <code class="literal">postgresql</code>
            (i.e <code class="literal">doas rcctl stop postgresql</code>).
          </p></li><li class="listitem"><p>
            Si tenías PostGIS vuelve a instalar el paquete desde el
            directorio con los paquetes con:
          </p><pre class="programlisting">
PKG_PATH=. doas pkg_add -r sqlite3 nghttp3 ngtcp2 curl zstd \
  libarchive tiff lcms2 geos hdf5 json-c netcdf proj minizip freexl \
  libspatialite gdal blosc libwebp postgis*
</pre></li><li class="listitem"><p>
            Inicia el servicio PostgreSQL
            (<code class="literal">doas rcctl -d start postgresql</code>) y
            comprueba su operación (<code class="literal">pgrep post</code> y
            examinando algunas bases).
          </p></li><li class="listitem"><p>
            Vuelve a activar la extensión PostGIS en las bases donde
            estaba. Si usaste el procedimiento del paso 2 desde la
            cuenta <code class="literal">_postgresql</code> ejecuta
            <code class="literal">/var/www/tmp/agrega-postgis.sh</code>
          </p></li></ol></div><p>
        Si habías detenido la actualización de
        <code class="literal">inst-adJ.sh</code> vuelve a ejecutarla y a la
        pregunta <span class="quote">“<span class="quote">Desea eliminar la actual versión de PostgreSQL y
        los datos asociados para actualizarla</span>”</span> responde No.
      </p><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="quitar-oids-para-actualizar-de-postgresql-11-a-12"></a>6.2.7.1. Quitar <code class="literal">OIDS</code> para actualizar de
        PostgreSQL 11 a 12</h5></div></div></div><p>
          En la actualización de PostgreSQL 11 a 12 se ha requerido un
          procedimiento adicional, previo a los pasos que se indicaron.
        </p><p>
          Por cada tabla, debe ejecutar
          <code class="literal">ALTER TABLE x SET WITHOUT OIDS;</code> cambiando x
          por el nombre de cada tabla.
        </p><p>
          Puede automatizarse con:
        </p><pre class="programlisting">
$ doas su - _postgresql
$ psql -U postgres -h /var/www/var/run/postgresql/
postgres=# \t on
postgres=# \o /tmp/quitaoids.sh
postgres=# SELECT '/usr/local/adJ/pg_quita_oids.sh ' || datname FROM
  pg_database WHERE datname NOT IN ('template0', 'template1', 'postgres');
postgres=# \q
</pre><p>
          note que se exluyen las bases <code class="literal">postgres</code>,
          <code class="literal">template0</code> y <code class="literal">template1</code>.
          El script <code class="literal">/usr/local/adJ/pg_quita_oids.sh</code>
          está disponible en
          <a class="ulink" href="https://github.com/pasosdeJesus/adJ/blob/master/arboldd/usr/local/adJ/pg_quita_oids.sh" target="_top">https://github.com/pasosdeJesus/adJ/blob/master/arboldd/usr/local/adJ/pg_quita_oids.sh</a>
        </p><p>
          Tras asegurar que tiene el script
          <code class="literal">/usr/local/adJ/pg_quita_oids.sh</code> y generar
          <code class="literal">/tmp/quitaoids.sh</code> como se describió,
          ejecute:
        </p><pre class="programlisting">
$ sh /tmp/quita_oids.sh
</pre></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="base-postgresql-remota"></a>6.2.8. Base PostgreSQL remota</h4></div></div></div><p>
        PostgreSQL permite conexiones remotas y cifradas, así que la
        aplicación puede estar en un servidor y la base de datos en
        otra.
      </p><p>
        Para la operación cifrada se requiere un certificado para el
        servidor y un certificado para cada usuario de la base de datos
        que se emplee en conexiones remotas. Los certificados para los
        clientes deben tener el CN con el nombre del usuario que hará la
        conexión. Por lo mismo en lugar de comprar certificados para
        esto es más práctico tener una autoridad certificadora que pueda
        firmarlos.
      </p><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="autoridad-certificadora-ssl"></a>6.2.8.1. Autoridad certificadora SSL</h5></div></div></div><p>
          Las operaciones con SSL depende en cliente y en servidor de la
          librería LibreSSL (en otros sistemas OpenSSL). Esta incluye el
          programa <code class="literal">openssl</code> para hacer varias
          operaciones, incluyendo operaciones de una autoridad
          certificadora.
        </p><p>
          Un certificado SSL siempre va con una llave privada (el
          certificado es la llave pública).
        </p><p>
          El proceso para crear un certificado es:
        </p><div class="orderedlist"><ol class="orderedlist compact" type="1"><li class="listitem"><p>
              Crear la llave privada para el certificado (extensión
              .key)
            </p></li><li class="listitem"><p>
              Generar el certificado (llave pública) pero sin firma
              (extensión .csr)
            </p></li><li class="listitem"><p>
              Firmar el certificado con una autoridad certificadora y
              generar el certificado
            </p></li><li class="listitem"><p>
              Usar el certificado firmado junto con la llave privada
              para realizar conexiones (el certificado firmado se
              compartirá, mientras que la llave privada no)
            </p></li></ol></div><p>
          Los archivos intermedios pueden examinarse así:
        </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
              Solicitudes:
              <code class="literal">openssl req -noout -text -in client.csr</code>
            </p></li><li class="listitem"><p>
              Llaves:
              <code class="literal">openssl rsa -check -in client.key</code>
            </p></li><li class="listitem"><p>
              Certificados:
              <code class="literal">openssl x509 -noout -text -in client.crt</code>
            </p></li></ul></div><p>
          La autoridad certificadora no es más que un certificado
          autofirmado que se configura y usa consistentemente como
          autoridad certificadora.
        </p></div><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="configuraci%C3%B3n-de-servidor"></a>6.2.8.2. Configuración de servidor</h5></div></div></div><p>
          En el servidor deben quedar certificados del servidor en
          <code class="literal">/var/postgresql/data</code>:
        </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
              root.crt Autoridad certificadora (igual a server.crt)
            </p></li><li class="listitem"><p>
              root.crl Lista de revocación
            </p></li><li class="listitem"><p>
              server.crt Certificado del servidor
            </p></li><li class="listitem"><p>
              server.key Llave privada del servidor
            </p></li></ul></div><p>
          Por cada cliente que se va a conectar debe configurarse en
          <code class="literal">/var/postgresql/data/pg_hba.conf</code> el/los
          usuarios que se conectarán. Contrario a lo especificado en la
          documentación de PostgreSQL en casos de SSL en ese archivo
          sólo nos han funcionado líneas de la forma:
        </p><pre class="programlisting">
    hostssl all usuario 192.168.100.11/32 cert clientcert=1
</pre><p>
          Es decir conexión SSL exigiendo certificado al cliente y que
          la autenticación sea por certificado. Lo cual también exige
          que el certificado del cliente tenga el CN igual al usuario.
        </p></div><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="configuraci%C3%B3n-de-cada-cliente"></a>6.2.8.3. configuración de cada cliente</h5></div></div></div><p>
          Para cada usuario debe hacerse un certificado que se ubica en
          cada comptuador cliente en
          <code class="literal">~/.postgresql/{usuario.crt, usuario.key}</code>
          donde usuario debe correponder al usuario en la base de datos
          y al CN del certificado.
        </p><p>
          Desde el servidor puede generar y firmar certificado para
          cliente por 10 años (cambie <code class="literal">usuario</code> por el
          usuario PostgreSQL dueño de la base de datos y que usara desde
          los clientes para conectarse, si prefiere un lapso de tiempo
          diferente especifíquelo en días después de la opción
          <code class="literal">-days</code>):
        </p><pre class="programlisting">
    doas su -
    cd /var/postgresql/data
    openssl genrsa -des3 -out usuario.key 1024
    openssl rsa -in usuario.key -out usuario.key
    openssl req -new -key usuario.key -out usuario.csr -subj '/C=CO/ST=Cundinamarca/L=Bogota/O=Pasos de Jesus/CN=usuario'
    openssl x509 -req -days 3650 -in usuario.csr -CA root.crt -CAkey server.key -out usuario.crt -CAcreateserial
</pre><p>
          A continuación copie el certificado generado
          (<code class="literal">usuario.crt</code>) y la llave privada
          (<code class="literal">usuario.key</code>) al computador cliente donde
          se usará:
        </p><pre class="programlisting">
    scp usuario.key usuario.crt mius@192.168.100.11:~/.postgresql/
</pre><p>
          En el servidor edite el archivo
          <code class="literal">/var/postgresql/data/pg_hba.conf</code> y
          asegúrese de agregar una línea para el usuario y el computador
          cliente:
        </p><pre class="programlisting">
    hostssl all usuario 192.168.100.11/32 cert clientcert=1
</pre><p>
          Reinicie PostgreSQL.
        </p><pre class="programlisting">
    doas rcctl -d restart postgresql
</pre><p>
          Desde el cliente ejecute:
        </p><pre class="programlisting">
    doas chmod 0600 /home/usis/.postgresql/usuario.key
</pre><p>
          y pruebe la conexión asegurando que se usa el certificado del
          usuario respectivo:
        </p><pre class="programlisting">
    PGSSLCERT=/home/usis/.postgresql/usuario.crt \
    PGSSLKEY=/home/usis/.postgresql/usuario.key  \
    psql -h192.168.100.21 -Uusuario usuario
</pre><p>
          Configure la aplicación para que en cada arranque o uso
          establezca:
        </p><pre class="programlisting">
    PGSSLCERT=/home/usis/.postgresql/usuario.crt
    PGSSLKEY=/home/usis/.postgresql/usuario.key
</pre><div class="sect5"><div class="titlepage"><div><div><h6 class="title"><a name="clientes-en-php"></a>6.2.8.3.1. Clientes en PHP</h6></div></div></div><p>
            Copie las llaves dentro de la jaula chroot, haga que el
            dueño sea www:www e incluya en alguna fuente usada antes de
            las conexiones a base de datos (por ejemplo intente en
            index.php):
          </p><pre class="programlisting">
    putenv('PGSSLCERT=/ojs/certs/ojs.crt');
    putenv('PGSSLKEY=/ojs/certs/ojs.key');
</pre></div><div class="sect5"><div class="titlepage"><div><div><h6 class="title"><a name="clientes-en-ruby-on-rails"></a>6.2.8.3.2. Clientes en Ruby on Rails</h6></div></div></div><p>
            En <code class="literal">config/database.yml</code> debe verse algo
            como:
          </p><pre class="programlisting">
    username: usuario
    host: 192.168.100.21
    sslmode: "require"
</pre><p>
            y al hacer operaciones que usen base de datos (rails
            dbconsole, iniciar unicorn, etc) asegúrese de ejecutarlas en
            un ambiente donde se definan bien las variables PGSSLCERT y
            PGSSLKEY, por ejemplo:
          </p><pre class="programlisting">
    PGSSLCERT=/home/usis/.postgresql/usuario.crt \
    PGSSLKEY=/home/usis/.postgresql/usuario.key \
    rails dbconsole
</pre></div></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="referencias-postgresql"></a>6.2.9. Referencias y lecturas recomendadas</h4></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            Documentación del paquete postgresql (README.OpenBSD,
            INSTALL).
          </p></li><li class="listitem"><p>
            Documentación disponible en el paquete
            <code class="literal">postgresql-doc</code> (ver postgresql-doc) y en
            <a class="ulink" href="http://www.postgresql.org/docs" target="_top">http://www.postgresql.org/docs</a>.
          </p></li><li class="listitem"><p>
            Páginas del manual de Unix: psql 1
          </p></li><li class="listitem"><p>
            SSL Certificates For PostgreSQL :
            <a class="ulink" href="https://www.howtoforge.com/postgresql-ssl-certificates" target="_top">https://www.howtoforge.com/postgresql-ssl-certificates</a>
          </p></li></ul></div></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="mariadb"></a>6.3. MariaDB</h3></div></div></div><p>
      A partir de OpenBSD/adJ 5.7 MariaDB remplaza a MySQL. Según
      <a class="ulink" href="https://es.wikipedia.org/wiki/MariaDB" target="_top">https://es.wikipedia.org/wiki/MariaDB</a>
      MariaDB fue iniciada por el fundador de MySQL después de que
      Oracle compró Sun y MySQL, pues consideraba que Oracle había hecho
      la compra para reducir competencia de sus bases de datos.
    </p><p>
      Debe instalar los paquetes mariadb-client-11.4.5v1 y
      mariadb-server-11.4.5p0v1. Aunque el nombre de los paquetes cambia
      las órdenes para operarla siguen siendo los mismos.
    </p><p>
      Inicialice el directorio donde estarán las bases de datos con
    </p><pre class="programlisting">
    doas /usr/local/bin/mysql_install_db
</pre><p>
      Para aumentar el límite de archivos que el usuario
      <code class="literal">_mysql</code> de clase <code class="literal">mysqld</code>
      agregue a <code class="literal">/etc/login.conf</code>:
    </p><pre class="programlisting">
    mysqld:\
        :openfiles-cur=2048:\
        :openfiles-max=4096:\
        :tc=servicio:
</pre><p>
      tenga en cuenta no dejar espacios al final de cada línea y que
      desde la segunda línea cada una comiencen con el caracter
      tabulador. A continuación regenere el archivo binario
      <code class="literal">/etc/login.conf.db</code> con
    </p><pre class="programlisting">
    cd /etc
    doas cap_mkdb /etc/login.conf
</pre><p>
      Cambie la clase del usuario <code class="literal">_mysql</code> de
      <code class="literal">servicio</code> a <code class="literal">mysqld</code>.
    </p><p>
      Después agregue <code class="literal">mysqld</code> a
      <code class="literal">pkg_scripts</code> en
      <code class="literal">/etc/rc.conf.local</code> por ejemplo con: doas rcctl
      enable mysqld
    </p><p>
      A continuación lance el servidor con:
    </p><pre class="programlisting">
    doas rcctl -d start mysqld
</pre><p>
      Los errores quedarán en <code class="literal">/var/mysql/host.err</code>.
    </p><p>
      Después puede establecer una clave para el usuario
      <code class="literal">root</code> de MariaDB cuando ingresa desde
      <code class="literal">localhost</code> con:
    </p><pre class="programlisting">
    doas su - root
    /usr/local/bin/mysqladmin -u root  password 'nueva-clave'
    /usr/local/bin/mysqladmin -u root -pnueva-clave -h Jesus.miong.org password 'nueva-clave'
</pre><p>
      Después puede iniciar una sesión, crear bases de datos, crear
      usuarios y otorgarles privilegios.
    </p><p>
      Para apagar el servidor mysql:
    </p><pre class="programlisting">
    mysqladmin -u root -p shutdown
</pre><p>
      Si desea usar mysql con php, instale además de los paquetes
      básicos de php (<code class="literal">php-core-v</code> y
      <code class="literal">php-mysqli-v</code>)
    </p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="uso-mariadb"></a>6.3.1. Uso básico</h4></div></div></div><pre class="programlisting">
    mysql -u root -p
</pre><p>
        puede crear la base de datos <code class="literal">datos</code>, y un
        usuario <code class="literal">erfurt</code> que la pueda administrar (i.e
        con todos los privilegios excepto GRANT) y con clave
        <code class="literal">vsewf</code> usando:
      </p><pre class="programlisting">
    CREATE DATABASE datos;
    GRANT ALL PRIVILEGES ON datos.* TO erfurt@localhost IDENTIFIED BY 'vsewf';
</pre><p>
        Algunas operaciones usuales del administrador son:
      </p><pre class="programlisting">
    SHOW DATABASES;
</pre><p>
        que muestra todas las bases disponibles.
      </p><pre class="programlisting">
    USE base1;
</pre><p>
        que permite usar la base base1.
      </p><pre class="programlisting">
    SHOW TABLES;
</pre><p>
        que muestra todas las tablas de la base activa.
      </p><pre class="programlisting">
    DESCRIBE tabla;
    SHOW CREATE TABLE tabla;
</pre><p>
        que presentan estructura de la tabla.
      </p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="clave-mysql"></a>6.3.2. Cambio de la clave de administrador</h4></div></div></div><p>
        Si olvida la clave de root después de haberla establecido puede
        cambiarla entrando a la cuenta de administrador:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            Detenga el servidor.
          </p></li><li class="listitem"><p>
            Inicie el servidor con
            <code class="literal">/usr/local/libexec/mysqld --user=root --skip-grant-tables</code>
            Esto usará el zócalo (socket) por omisión en
            <code class="literal">/var/run/mysql</code>, si no existe esa ruta
            creela con <code class="literal">mkdir /var/run/mysql</code> y dele
            permisos con
            <code class="literal">chown _mysql:_mysql /var/run/mysql</code>
          </p></li><li class="listitem"><p>
            Ejecute:
          </p><pre class="programlisting">
    # mysql
    mysql&gt; USE mysql
    mysql&gt; UPDATE user SET PASSWORD=password('miclave') WHERE user='root';
    mysql&gt; FLUSH PRIVILEGES;
    mysql&gt; EXIT
</pre></li><li class="listitem"><p>
            Vuelva a apagar el servidor y reinicielo con:
            <code class="literal">/usr/local/bin/mysqld_safe &amp;</code>
          </p></li></ul></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="recuperacion-backups"></a>6.3.3. Recuperación y backups</h4></div></div></div><p>
        MariaDB mantiene bases de datos en directorios y las tablas en
        archivos. No es recomendable que modifique tales archivos, al
        menos no, mientras el servidor esté activo.
      </p><p>
        Para sacar una copia de respaldo de todas las bases de datos
        con:
      </p><pre class="programlisting">
    mysqldump --force -p --all-databases &gt; /respaldomysql/dump-1nov2007.sql
</pre><p>
        y posteriormente restaurarla con:
      </p><pre class="programlisting">
    mysql &lt; /respaldomysql/dump-1nov2007.sql
</pre></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="chroot-mysql"></a>6.3.4. MariaDB y servidor web con chroot</h4></div></div></div><p>
        Puede emplear aplicaciones para nginx en modo
        <code class="literal">chroot</code> que usen bases de datos MariaDB de
        tres formas: (1) Conectando la aplicación web a la base de datos
        mediante un puerto TCP/IP donde responda MariaDB, (2) poniendo
        el zócalo de MariaDB en un directorio dentro de la jaula del
        servidor web o (3) Corriendo MariaDB dentro de la jaula
        <code class="literal">chroot</code> (ver
        <a class="ulink" href="http://structio.sourceforge.net/guias/servidor_OpenBSD/mysql.html#mysql-chroot" target="_top">http://structio.sourceforge.net/guias/servidor_OpenBSD/mysql.html#mysql-chroot</a>).
      </p><p>
        A continuación documentamos como ubicar el zócalo de MariaDB
        dentro de la jaula del servidor web (/var/www/) que nos parece
        un método seguro y fácil de implementar.
      </p><p>
        Una vez instale <code class="literal">mariadb-server</code> cree el
        directorio en el cual ubicará el zócalo, digamos:
      </p><pre class="programlisting">
        doas mkdir -p /var/www/var/run/mysql/
        doas chown _mysql:_mysql /var/www/var/run/mysql/
        doas chmod a+w /var/www/var/run/mysql/
        doas chmod +t /var/www/var/run/mysql/
</pre><p>
        y después puede bien iniciar MariaDB indicando la ruta del
        zócalo con la opción <code class="literal">--socket</code> y en cada uso
        del cliente <code class="literal">mysql</code> también debe especificar
        ese parámetro, o bien puede configurar en
        <code class="literal">/etc/my.cnf</code> en la sección
        <code class="literal">client-server</code> el zócalo por omisión con:
      </p><pre class="programlisting">
    [client-server]
    socket = /var/www/var/run/mysql/mysql.sock
</pre><p>
        Reinicie el servicio con:
      </p><pre class="programlisting">
    doas rcctl -d restart mysqld
</pre><p>
        Puede verificar que el zócalo queda bien ubicado con:
      </p><pre class="programlisting">
    $ ls -l /var/www/var/run/mysql/
</pre><p>
        que debe responde con algo como
      </p><pre class="programlisting">
    srwxrwxrwx  1 _mysql  _mysql  0 Jul 18 21:41 mysql.sock
</pre><p>
        Así una aplicación PHP que corran en el mismo servidor podrían
        realizar una conexión con:
      </p><pre class="programlisting">
        $dbhost  = "localhost";
        $dbuname = "miusuario";
        $dbpass  = "miclave";
        mysql_connect($dbhost, $dbuname, $dbpass);
</pre><p>
        Tenga en cuenta también que otros binarios de MariaDB también
        requerirán la opción
        <code class="literal">--socket=/var/www/var/run/mysql/mysql.sock</code> al
        ejecutarse por ejemplo:
      </p><pre class="programlisting">
    mysqldump --socket=/var/www/var/run/mysql/mysql.sock  \
    -p --all-databases
</pre></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="lecutras-mysql"></a>6.3.5. Lecturas recomendadas</h4></div></div></div><p>
        Referencias:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            Una explicación de algo de la instalación y el uso de MySQL
            en OpenBSD:
            <a class="ulink" href="http://www.sancho2k.net/filemgmt_data/files/mysql_notes.html" target="_top">http://www.sancho2k.net/filemgmt_data/files/mysql_notes.html</a>
          </p></li><li class="listitem"><p>
            La documentación de MariaDB :
            <a class="ulink" href="https://mariadb.com/kb/en/mariadb/documentation/" target="_top">https://mariadb.com/kb/en/mariadb/documentation/</a>
          </p></li><li class="listitem"><p>
            Ayuda para cambiar clave de root en sistemas Linux:
            <a class="ulink" href="http://www.netadmintools.com/art90.html" target="_top">http://www.netadmintools.com/art90.html</a>
          </p></li></ul></div></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="ldapd"></a>6.4. Servidor ldapd</h3></div></div></div><p>
      LDAP (Lightweight Directory Access Protocol) es un protocolo para
      mantener e intercambiar información almacenada en directorios (i.e
      bases de datos especiales), su versión 3 se define en los RFC
      2251, 2256, 2829, 2830 y 3377.
    </p><p>
      Un uso típico de LDAP es mantener en un servidor información de
      los usuarios de una organización para permitir su autenticación en
      otros servicios (e.g nombres, apellidos, dirección, teléfono,
      login, clave).
    </p><p>
      OpenBSD incluye (desde OpenBSD 4.8) un servidor para LDAP versión
      3, <code class="literal">ldapd</code>. No incluye cliente para LDAP pero
      desde la línea de órdenes puede emplearse el paquete
      <code class="literal">openldap-client</code> o como interfaz web
      <code class="literal">phpldapadmin</code><a href="#ftn.id3382" class="footnote" name="id3382"><sup class="footnote">[31]</sup></a>.
    </p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="instalacion-ldapd"></a>6.4.1. Instalación de ldapd</h4></div></div></div><p>
        No necesita instalar paquetes para la operación como servidor.
      </p><p>
        La configuración que se presenta emplea LDAPS para conexiones en
        la red local, empleando un certificados cuyas llaves pública y
        privada debe copiarse a <code class="literal">/etc/ldap/certs</code> y
        ejecutar:
      </p><pre class="programlisting">
    cd /etc/ldap/certs
    chown _ldapd:_ldapd *
    chmod 0640 /etc/ldap/certs/*key
    chmod 0644 /etc/ldap/certs/*crt
</pre><p>
        Para configurar el servidor, verifique que exista el usuario
        <code class="literal">_ldapd</code> y el grupo <code class="literal">_ldapd</code> y
        edite <code class="literal">/etc/ldapd.conf</code>:
      </p><pre class="programlisting">
    schema "/etc/ldap/core.schema"
    schema "/etc/ldap/inetorgperson.schema"
    schema "/etc/ldap/nis.schema"

    lan_if = "re1"

    listen on $lan_if ldaps certificate www.pasosdeJesus.org
    listen on lo0 secure
    listen on "/var/run/ldapi"

    namespace "dc=www,dc=pasosdeJesus,dc=org" {
            rootdn          "cn=root,dc=www,dc=pasosdeJesus,dc=org"
            rootpw          "secret"
            index           sn
            index           givenName
            index           cn
            index           mail
            index           objectClass
            index           sn
            fsync           on
    }
</pre><p>
        Recuerde que la clave del directorio debe ser mejor que la
        presentada (i.e remplace <code class="literal">secret</code> por una buena
        clave). En lugar de poner la clave plana también es posible
        poner la cadena generada con:
      </p><pre class="programlisting">
    doas slappasswd -v -u -h {CRYPT} -s secret
</pre><p>
        que en el caso de la clave
        <span class="quote">“<span class="quote"><code class="literal">secret</code></span>”</span> es
        <span class="quote">“<span class="quote"><code class="literal">{CRYPT}uPUCy906TIu/k</code></span>”</span>
      </p><p>
        La configuración por defecto emplea
        <code class="literal">/var/db/ldap</code> como directorio para mantener
        las bases de datos y mantiene una por cada espacio de nombres
        (namespace). Las conexiones no cifradas por defecto operan en el
        puerto 389 y deben autenticarse con SASL (a menos que tengan la
        opción <code class="literal">secure</code> para permitir autenticación
        plana) y las que empleen certificado irán cifradas en el puerto
        636.
      </p><p>
        Cada vez que modifique el archivo de configuración del servidor,
        puede verificarlo con:
      </p><pre class="programlisting">
    doas ldapd -n
</pre><p>
        Para iniciar el servidor LDAP en modo de depuración para ver
        posibles errores:
      </p><pre class="programlisting">
    doas ldapd -dv
</pre><p>
        Tras verificar el funcionamiento, para que en cada arranque se
        inicie el servidor puede agregar a
        <code class="literal">/etc/rc.conf.local</code>:
      </p><pre class="programlisting">
    ldapd_flags=""
    pkg_scripts = "ldapd"
</pre><p>
        E iniciar el servicio con
        <code class="literal">rcctl -d start ldapd</code> y detenerlo con
        <code class="literal">rcctl  -d stop ldapd</code>
      </p><p>
        Es muy recomendable que agregue el esquema LDAP de Courier, de
        esta forma tomada de {3}:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            Descárguelo y renómbrelo:
          </p><pre class="programlisting">
    doas ftp -o /etc/ldap/courier.schema \
    http://courier.cvs.sourceforge.net/viewvc/courier/libs/authlib/authldap.schema
</pre></li><li class="listitem"><p>
            Edite /etc/ldap/courier.schema y quite comentario a las
            líneas:
          </p><pre class="programlisting">
    attributetype ( 1.3.6.1.4.1.10018.1.1.14 NAME 'mailhost'
            DESC 'Host to which incoming POP/IMAP connections should be proxied'
            EQUALITY caseIgnoreIA5Match
            SYNTAX 1.3.6.1.4.1.1466.115.121.1.26{256} )
</pre></li><li class="listitem"><p>
            Reinicie ldapd
          </p></li></ul></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="pruebas-openldap"></a>6.4.2. Pruebas Iniciales con openldap-client</h4></div></div></div><p>
        Instale el paquete con:
      </p><pre class="programlisting">
    doas pkg_add openldap-client
</pre><p>
        Verifique localmente que el servidor no cifrado corre con:
      </p><pre class="programlisting">
    ldapsearch -x -b 'dc=www,dc=pasosdeJesus,dc=org' '(objectclass=*)'
</pre><p>
        Respecto al servidor cifrado puede analizar la conexión SSL con:
      </p><pre class="programlisting">
    openssl s_client -connect 192.168.2.1:636
</pre><p>
        Si está usando un certificado firmado por su propia autoridad
        certificadora y obtiene un error como
        <code class="literal">verify error:num=21:unable to verify the first certificate</code>
        asegurese de:
      </p><div class="orderedlist"><ol class="orderedlist compact" type="1"><li class="listitem"><p>
            Que el certificado de su autoridad certificadora no haya
            expirado
          </p></li><li class="listitem"><p>
            Agregar el certificado de su autoridad certificadora al
            archivo <code class="literal">/etc/ssl/certs.pem</code>
          </p></li></ol></div><p>
        Puede verificar sus certificados contra la entidad que los
        expide siguiendo instrucciones de {4}.
      </p><p>
        Puede deshabilitar la verificación de certificados de ldapsearch
        poniendo en <code class="literal">/etc/openldap/ldap.conf</code>:
      </p><pre class="programlisting">
    TLS_REQCERT never
</pre><p>
        Por otra parte si prefiere que <code class="literal">ldapsearch</code>
        haga verificaciones completas de certificados, descargue el
        certificado de su entidad certificadora y agreguelo por ejemplo
        a <code class="literal">/etc/ssl/certs/ca-certificates.crt</code> y
        agregue a <code class="literal">/etc/ldap/ldap.conf</code> la línea:
      </p><pre class="programlisting">
TLS_CACERT      /etc/ssl/certs/ca-certificates.crt
</pre><p>
        Con esto, al ejecutar:
      </p><pre class="programlisting">
ldapsearch -H ldaps://www.pasosdeJesus.org -x -b "dc=pasosdeJesus,dc=org"
'(objectclass=*)'
</pre><p>
        debería obtener
      </p><pre class="programlisting">
# extended LDIF
#
# LDAPv3
# base &lt;dc=pasosdeJesus,dc=org&gt; with scope subtree
# filter: (objectclass=*)
# requesting: ALL
#

# search result
search: 2
result: 32 No such object

# numResponses: 1
</pre><p>
        Para hacer pruebas desde otro computador, tenga en cuenta que en
        OpenBSD <code class="literal">ldapsearch</code> utiliza openssl mientras
        que por ejemplo en Ubuntu emplea GNUTLS.
      </p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="datos-iniciales-ldapd"></a>6.4.3. Adición de datos iniciales</h4></div></div></div><p>
        Una vez esté corriendo <code class="literal">ldapd</code> deberá iniciar
        un directorio para su organización y los usuarios que se
        autenticarán. Puede agregar estos datos con el programa
        <code class="literal">ldapadd</code> que hace parte de openldap-client.
        Programa que recibe datos en formato ldif, por ejemplo leídos de
        un archivo. Un primer archivo con datos de la organización puede
        ser <code class="literal">org.ldif</code> y contener:
      </p><pre class="programlisting">
    dn:     dc=www,dc=pasosdeJesus,dc=org
    objectClass:    dcObject
    objectClass:    organization
    o:      Pasos de Jesús
    dc:     correo

    dn: cn=admin,dc=correo,dc=pasosdeJesus,dc=org
    objectClass: organizationalRole
    cn: admin

    dn:ou=gente, dc=correo,dc=pasosdeJesus,dc=org
    objectClass:    top
    objectClass:    organizationalUnit
    ou:     gente

    dn:ou=grupos,dc=correo,dc=pasosdeJesus,dc=org
    objectClass:    top
    objectClass:    organizationalUnit
    ou:     grupos

    dn:ou=sendmail,dc=www,dc=pasosdeJesus,dc=org
    ou: sendmail
    objectClass: top
    objectClass: organizationalUnit
    userPassword: sendmail
</pre><p>
        Nota: Al agregar información verifique no dejar espacios en
        blanco al final de cada línea. Se pueden agregar
        <code class="literal">org.ldif</code> con:
      </p><pre class="programlisting">
    ldapadd -x -D "cn=admin,dc=www,dc=pasosdeJesus,dc=org" -W \
    -h www.pasosdeJesus.org -f org.ldif
</pre><p>
        Además de poder revisar los mensajes que
        <code class="literal">slapd</code> genere al ejecutarse en modo de
        depuración, podrá consultar los datos ingresados al directorio
        con:
      </p><pre class="programlisting">
    ldapsearch -x -b 'dc=www,dc=pasosdeJesus,dc=org' '(objectclass=*)'
</pre></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="phpldapadmin"></a>6.4.4. Instalación y configuración de
      <code class="literal">phpldapadmin</code></h4></div></div></div><p>
        Aunque hay un paquete para OpenBSD, la igual que la distribución
        oficial de phpldapadmin no soporta php-5.5 ni TLS, por lo que se
        recomienda emplear
        <a class="ulink" href="https://github.com/leenooks/phpLDAPadmin" target="_top">https://github.com/leenooks/phpLDAPadmin</a>
        así:
      </p><pre class="programlisting">
# mkdir -p ~/servidor/
# cd ~/servidor/
# git clone https://github.com/leenooks/phpLDAPadmin.git
# cp -rf phpLDAPadmin /var/www/phpldapadmin
# doas ln -s ../phpldapadmin /var/www/htdocs/phpldapadmin
# doas $EDITOR /var/www/phpldapadmin/config/config.php
</pre><p>
        para configurarlo (use su editor preferido en lugar de $EDITOR o
        defina esa variable) es importante que por lo menos quite el
        comentario a la línea
      </p><pre class="programlisting">
$config-&gt;custom-&gt;jpeg['tmpdir'] = '/tmp';
</pre><p>
        También debe asegurar que pueden emplearse los dispositivos de
        generación de números aleatorios en la jaula chroot de nginx
        (esto lo hace por defecto el instalador de adJ 5.5). Para esto
        verifique que en <code class="literal">/etc/fstab</code> al montar la
        partición <code class="literal">/var</code> este permitiendo dispositivos
        (que no este la opción <code class="literal">nodev</code>) y ejecute:
      </p><pre class="programlisting">
    cd /var/www
    doas mkdir -p dev
    cd dev
    /dev/MAKEDEV arandom
</pre><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="preparando-cuentas"></a>6.4.4.1. Preparando cuentas</h5></div></div></div><p>
          Primero cree un grupo <code class="literal">posix</code> en grupos. A
          continuación cree cuentas de usuario, tenga en cuenta que en
          la configuración por omisión debe emplear cifrado SHA para la
          clave (que no es tan seguro pero es el común que es soportada
          tanto por <code class="literal">phpLdapAdmin</code> como por
          <code class="literal">ldadpd</code>).
        </p></div><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="diferencias-con-openldap"></a>6.4.4.2. Diferencias con OpenLDAP</h5></div></div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
              El renombramiento de objetos opera con OpenLDAP pero no
              con ldapd.
            </p></li></ul></div></div><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="ayudas-para-depurar-problemas-con-ldap-y-php"></a>6.4.4.3. Ayudas para depurar problemas con LDAP y PHP</h5></div></div></div><p>
          Para depurar problemas de conexión de clientes en PHP a ldadp
          ha servido recordar:
        </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
              libssl: Realiza conexiones seguras SSL y TLS
            </p></li><li class="listitem"><p>
              Librerías de OpenLDAP: son usadas practicamente por todos
              los programas para realizar conexiones LDAP.
            </p></li><li class="listitem"><p>
              Desde el cliente, es buen experimento probar que desde la
              jauala chroot <code class="literal">/var/www</code> se puedan hacer
              conexiones SSL con <code class="literal">openssl s_client</code> y
              que se pueda ejecutar <code class="literal">ldapsearch</code>
              (aunque por lo visto php-ldap no utiliza archivos de
              configuración de <code class="literal">ldapsearch</code> como
              <code class="literal">/etc/openldap/ldap.conf</code>).
            </p></li><li class="listitem"><p>
              PHP: Su móduo ldapd debe estar compilado con las mismas
              librerías libssl y OpenLDAP usadas en el sistema.
            </p></li><li class="listitem"><p>
              Puede probar con un programa php como este:
            </p></li></ul></div><pre class="programlisting">

function muestra_est_ldap($ad) {
  ldap_get_option($ad, LDAP_OPT_DEREF, $deref);
  echo "deref=$deref\n";
  ldap_get_option($ad, LDAP_OPT_SIZELIMIT, $sizelimit);
  echo "sizelimit=$sizelimit\n";
  ldap_get_option($ad, LDAP_OPT_TIMELIMIT, $timelimit);
  echo "timelimit=$timelimit\n";
  ldap_get_option($ad, LDAP_OPT_NETWORK_TIMEOUT, $network_timeout);
  echo "network_timeout=$network_timeout\n";
  ldap_get_option($ad, LDAP_OPT_PROTOCOL_VERSION, $protocol_version);
  echo "protocol_version=$protocol_version\n";
  ldap_get_option($ad, LDAP_OPT_ERROR_NUMBER, $error_number);
  echo "error_number=$error_number\n";
  ldap_get_option($ad, LDAP_OPT_REFERRALS, $referrals);
  echo "referrals=$referrals\n";
  ldap_get_option($ad, LDAP_OPT_RESTART, $restart);
  echo "restart=$restart\n";
  ldap_get_option($ad, LDAP_OPT_HOST_NAME, $host_name);
  echo "host_name=$host_name\n";
  ldap_get_option($ad, LDAP_OPT_ERROR_STRING, $error_string);
  echo "error_string=$error_string\n";
  #ldap_get_option($ad, LDAP_OPT_MATCHED_ON, $error_string);
  #echo "error_string=$error_string\n";
  ldap_get_option($ad, LDAP_OPT_SERVER_CONTROLS, $error_string);
  echo "error_string=$error_string\n";
  # LDAP_OPT_ERROR_STRING string
  # LDAP_OPT_MATCHED_DN string
  # LDAP_OPT_SERVER_CONTROLS array
  # LDAP_OPT_CLIENT_CONTROLS
  #
}

echo "openssl_get_cert_location: ";
var_dump(openssl_get_cert_locations());
echo "";
$ldap_server = "ldaps://apbd1.miorg.org.co/";
$ldap_user = "cn=unusuario,ou=gente,dc=miorg,dc=org,dc=co";
$ldap_pass = "unusuario";

putenv('LDAPTLS_REQCERT=never');
ldap_set_option(NULL, LDAP_OPT_DEBUG_LEVEL, 7);

$ad = ldap_connect($ldap_server) or die("No se pudo conectar a {$ldap_server}");
echo "ad= "; print_r($ad); echo "\n";

muestra_est_ldap($ad);
echo "Intentando conectar con $ldap_user - $ldap_pass\n";
$conectado = @ldap_bind($ad, $ldap_user, $ldap_pass);

if (!$conectado) {
  echo "No se pudo conectar al servidor\n";
  echo "Mensaje de error OpenLdap: " . ldap_error($ad) . "\n";
  muestra_est_ldap($ad);
  exit;
}

echo "conectado= "; print_r($conectado); echo "\n"
</pre></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="referencias-ldapd"></a>6.4.5. Referencias y lecturas recomendadas</h4></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            Las siguientes páginas man: ldapd 8. ldapctl 8. ldapd.conf
            5.
          </p></li><li class="listitem"><p>
            <a class="ulink" href="https://dhobsd.pasosdejesus.org/ldapd.html" target="_top">https://dhobsd.pasosdejesus.org/ldapd.html</a>.
          </p></li><li class="listitem"><p>
            <a class="ulink" href="http://www.cyberciti.biz/faq/test-ssl-certificates-diagnosis-ssl-certificate/" target="_top">http://www.cyberciti.biz/faq/test-ssl-certificates-diagnosis-ssl-certificate/</a>.
          </p></li><li class="listitem"><p>
            <a class="ulink" href="http://www.tumfatig.net/20120817/monitoring-openbsds-ldap-daemon/" target="_top">http://www.tumfatig.net/20120817/monitoring-openbsds-ldap-daemon/</a>.
          </p></li><li class="listitem"><p>
            <a class="ulink" href="http://openbsd.7691.n7.nabble.com/dev-random-as-chrooted-named-s-entropy-source-current-td64344.html" target="_top">http://openbsd.7691.n7.nabble.com/dev-random-as-chrooted-named-s-entropy-source-current-td64344.html</a>.
          </p></li></ul></div></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="autoridad_certificadora"></a>6.5. Autoridad certificadora interna</h3></div></div></div><p>
      Los servicios en red (en particular ldapd, ver
      <a class="xref" href="otros_servicios_que_puede_prestar_el_servidor.html#ldapd" title="6.4. Servidor ldapd">Sección 6.4, “Servidor ldapd”</a> y postgresql remoto, ver
      <a class="xref" href="otros_servicios_que_puede_prestar_el_servidor.html#postgresql" title="6.2. Motor de bases de datos PostgreSQL">Sección 6.2, “Motor de bases de datos PostgreSQL”</a>) requieren cada vez más
      comunicaciones cifradas y suelen emplear SSL o TLS que requieren
      certificados públicos firmados por autoridades certificadoras.
    </p><p>
      Cada vez los programas, librerías y lenguajes están verificando
      con más insistencia que los certificados sean efectivamente
      firmados por autoridades certificadoras.
    </p><p>
      En general las autoridades certificadoras cobran por emitir firmas
      para certificados. Sin embargo
      <a class="ulink" href="http://letsencrypt.org" target="_top">http://letsencrypt.org</a>
      es una autoridad certificadora que expide certificados gratuitos
      para sitios públicos pero no para sitios en redes internas por
      cuanto el proceso de expedición de certificados requiere resolver
      por DNS desde sus servidores el dominio para el cual se está
      creando el certificado. Además sus certificados deben renovarse
      cada 3 meses (ver <a class="xref" href="protocolos_de_soporte_y_de_usuario.html#letsencrypt" title="5.7.2. Certificados SSL gratuitos con Let’s Encrypt">Sección 5.7.2, “Certificados SSL gratuitos con Let’s Encrypt”</a>).
    </p><p>
      Esto hace necesario que cada organización que requiere servicios
      cifrados con SSL o TLS en su red interna (como PostgreSQL remoto o
      LDAP) cuente con su propia autoridad certificadora interna
    </p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="conceptos"></a>6.5.1. Conceptos</h4></div></div></div><p>
        Las operaciones con SSL dependen en cliente y en servidor de la
        librería LibreSSL (en otros sistemas OpenSSL). Esta incluye el
        programa openssl para hacer varias operaciones, incluyendo
        operaciones de una autoridad certificadora.
      </p><p>
        Un certificado SSL siempre se asocia a una llave privada (el
        certificado es la llave pública).
      </p><p>
        El proceso para crear un certificado es:
      </p><div class="orderedlist"><ol class="orderedlist compact" type="1"><li class="listitem"><p>
            Crear la llave privada para el certificado (extensión .key)
          </p></li><li class="listitem"><p>
            Generar el certificado (llave pública) pero sin firma
            (extensión .csr)
          </p></li><li class="listitem"><p>
            Firmar el certificado con una autoridad certificadora y
            generar el certificado
          </p></li><li class="listitem"><p>
            Usar el certificado firmado junto con la llave privada para
            realizar conexiones (el certificado firmado se compartirá,
            mientras que la llave privada no)
          </p></li></ol></div><p>
        Los archivos intermedios pueden examinarse así:
      </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
            Solicitudes:
            <code class="literal">openssl req -noout -text -in client.csr</code>
          </p></li><li class="listitem"><p>
            Llaves: <code class="literal">openssl rsa -check -in client.key</code>
          </p></li><li class="listitem"><p>
            Certificados:
            <code class="literal">openssl x509 -noout -text -in client.crt</code>
          </p></li></ul></div><p>
        La autoridad certificadora no es más que un certificado
        autofirmado que se configura y se usa consistentemente como
        autoridad certificadora.
      </p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="configuraci%C3%B3n-de-servidor-1"></a>6.5.2. Configuración de servidor</h4></div></div></div><p>
        Supongamos que ubicamos en
        <code class="literal">/var/postgresql/data</code> los archivos de la
        autoridad certificadora:
      </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
            <code class="literal">root.crt</code> Autoridad certificadora (igual a
            server.crt)
          </p></li><li class="listitem"><p>
            <code class="literal">root.crl</code> Lista de revocación
          </p></li><li class="listitem"><p>
            <code class="literal">server.crt</code> Certificado del servidor
          </p></li><li class="listitem"><p>
            <code class="literal">server.key</code> Llave privada del servidor
          </p></li></ul></div><p>
        Se pueden generar así (como se explica en
        <a class="ulink" href="https://www.howtoforge.com/postgresql-ssl-certificates" target="_top">https://www.howtoforge.com/postgresql-ssl-certificates</a>):
      </p><pre class="programlisting">
    openssl genrsa -des3 -out server.key 1024
    openssl rsa -in server.key -out server.key
    chmod 400 server.key
    chown postgres.postgres server.key
    openssl req -new -key server.key -days 3650 -out server.crt -x509 -subj '/C=CO/ST=Bogota/L=MiOng/O=MiOng/CN=miong.org.co/emailAddress=info@miong.org'
</pre></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="generaci%C3%B3n-de-un-par-de-certificados"></a>6.5.3. Generación de un par de certificados</h4></div></div></div><p>
        LDAP requiere que el CN del certificado corresponda al nombre
        del computador en la red interna.
      </p><p>
        Los certificados para clientes de PostgreSQL requieren que el CN
        del Certificado corresponda al usuario en la base de datos.
      </p><p>
        En el computador que hará la conexión (en este ejemplo
        <code class="literal">apbd2.miong.org.co</code>) ejecute:
      </p><pre class="programlisting">
    mkdir ~/ssl
    cd ~/ssl
    openssl genrsa -des3 -out apbd2.miong.org.co.key 1024
    openssl rsa -in apbd2.miong.org.co.key -out apbd2.miong.org.co.key
</pre><p>
        De una clave temporal y bórrela con
      </p><pre class="programlisting">
    openssl rsa -in apbd2.miong.org.co.key -out apbd2.miong.org.co.key
</pre><p>
        Cree la solicitud de certificado con:
      </p><pre class="programlisting">
    openssl req -new -key apbd2.miong.org.co.key -out apbd2.miong.org.co.csr -subj '/C=CO/ST=Cundinamarca/L=Bogota/O=MIONG/CN=apbd2.miong.org.co'
</pre><p>
        Copie la solicitud <code class="literal">apbd2.miong.org.co.csr</code> al
        servidor apbd1.miong.org.co y déjela en el directorio
        <code class="literal">/var/postgresql/data</code>
      </p><p>
        Y allí ejecute:
      </p><pre class="programlisting">
    doas su -
    cd /var/postgresql/data
    openssl x509 -req -days 3650 -in apbd2.miong.org.co.csr -CA root.crt -CAkey server.key -out apbd2.miong.org.co.crt -CAcreateserial
</pre><p>
        A continuación copie el certificado generado
        (<code class="literal">apbd2.miong.org.co.crt</code>) al computador
        cliente donde se usará:
      </p><pre class="programlisting">
    scp apbd2.miong.org.co.crt apbd2.miong.org.co:~/ssl/
</pre></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="uso-de-los-certificados"></a>6.5.4. Uso de los certificados</h4></div></div></div><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="caso-postgresql"></a>6.5.4.1. Caso PostgreSQL</h5></div></div></div><p>
          En el servidor edite el archivo
          <code class="literal">/var/postgresql/data/pg_hba.conf</code> y
          asegúrese de agregar una línea para el usuario y el computador
          cliente: hostssl all usuario 192.168.100.11/32 cert
          clientcert=1
        </p><p>
          Reinicie PostgreSQL.
        </p><pre class="programlisting">
    doas rcclt -d restart postgresql
</pre><p>
          Desde el cliente ejecute:
        </p><pre class="programlisting">
    doas chmod 0600 /home/usis/.postgresql/usuario.key
</pre><p>
          y pruebe la conexión asegurando que se usa el certificado del
          usuario respectivo:
        </p><pre class="programlisting">
    PGSSLCERT=/home/usis/.postgresql/usuario.crt \
    PGSSLKEY=/home/usis/.postgresql/usuario.key \
    psql -h192.168.100.21 -Uusuario usuario
</pre><p>
          Configure la aplicación para que en cada arranque o uso
          establezca:
        </p><pre class="programlisting">
    PGSSLCERT=/home/usis/.postgresql/usuario.crt
    PGSSLKEY=/home/usis/.postgresql/usuario.key
</pre></div><div class="sect4"><div class="titlepage"><div><div><h5 class="title"><a name="caso-ldapd"></a>6.5.4.2. Caso LDAPD</h5></div></div></div><p>
          Ubique el certificado y llave en
          <code class="literal">/etc/ldap/certs/</code> del servidor donde corre
          ldapd:
        </p><pre class="programlisting">
    doas cp apbd2.miong.org.co.{key,crt} /etc/ldap/certs/
</pre><p>
          Configure <code class="literal">/etc/ldapd.conf</code>
        </p><pre class="programlisting">
    listen on $if1 tls certificate apbd2.miong.org.co
</pre><p>
          En los computadores que realicen conexiones al LDAP asegúrese
          de agregar la llave de la entidad certificadora
          <code class="literal">/var/postgresql/data/root.crt</code>, es decir en
          el servidor apbd1 ejecute:
        </p><pre class="programlisting">
    cd /var/postgresql/data
    openssl x509 -noout -text -in root.crt &gt; root-paracerts
</pre><p>
          Copie el archivo <code class="literal">root-paracerts</code> en el
          cliente y agregue ese archivo al final de
          <code class="literal">/etc/ssl/cert.pem</code>
        </p></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="referencias"></a>6.5.5. Referencias</h4></div></div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
            <a class="ulink" href="https://www.howtoforge.com/postgresql-ssl-certificates" target="_top">https://www.howtoforge.com/postgresql-ssl-certificates</a>
          </p></li></ul></div></div></div><div class="footnotes"><br><hr style="width:100; text-align:left;margin-left: 0"><div id="ftn.id2891" class="footnote"><p xmlns="http://www.w3.org/TR/xhtml1/transitional"><sup>[<a name="ftn.id2891" href="#id2891">29</a>] </sup>
            Note que de esta forma puede cambiar la clave de otros
            usuarios de PostgreSQL.
          </p></div><div id="ftn.id3029" class="footnote"><p xmlns="http://www.w3.org/TR/xhtml1/transitional"><sup>[<a name="ftn.id3029" href="#id3029">30</a>] </sup>
                Si no logras ubicar el script en
                <code xmlns="" class="literal">/usr/local/adJ/pg_preact_postgis.sh</code>
                descargalo de
                <a xmlns="" class="ulink" href="https://gitlab.com/pasosdeJesus/adJ/-/blob/ADJ_7_4/arboldd/usr/local/adJ/pg_preact_postgis.sh" target="_top">https://gitlab.com/pasosdeJesus/adJ/-/blob/ADJ_7_4/arboldd/usr/local/adJ/pg_preact_postgis.sh</a>
              </p></div><div id="ftn.id3382" class="footnote"><p xmlns="http://www.w3.org/TR/xhtml1/transitional"><sup>[<a name="ftn.id3382" href="#id3382">31</a>] </sup>
          Si emplea un adJ 5.2 y planea conectarse desde clientes
          digamos en Ubuntu reciente requerirá el parche descrito en
          <a xmlns="" class="ulink" href="http://openbsd.7691.n7.nabble.com/ldapd-and-quot-The-Diffie-Hellman-prime-sent-by-the-server-is-not-acceptable-quot-td59635.html" target="_top">http://openbsd.7691.n7.nabble.com/ldapd-and-quot-The-Diffie-Hellman-prime-sent-by-the-server-is-not-acceptable-quot-td59635.html</a>
        </p></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="protocolos_de_soporte_y_de_usuario.html">Anterior</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="novedades.html">Siguiente</a></td></tr><tr><td width="40%" align="left" valign="top">5. Protocolos de soporte y de usuario </td><td width="20%" align="center"><a accesskey="h" href="index.html">Inicio</a></td><td width="40%" align="right" valign="top"> A. Novedades</td></tr></table></div></body></html>
