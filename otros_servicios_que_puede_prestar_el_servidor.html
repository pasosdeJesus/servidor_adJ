<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>6. Otros servicios que puede prestar el servidor</title><meta name="generator" content="DocBook XSL Stylesheets V1.68.1"><link rel="start" href="index.html" title="La distribución Aprendiendo de Jesús como servidor y cortafuegos"><link rel="up" href="index.html" title="La distribución Aprendiendo de Jesús como servidor y cortafuegos"><link rel="prev" href="protocolos_de_soporte_y_de_usuario.html" title="5. Protocolos de soporte y de usuario"><link rel="next" href="novedades.html" title="A. Novedades"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">6. Otros servicios que puede prestar el servidor</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="protocolos_de_soporte_y_de_usuario.html">Anterior</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="novedades.html">Siguiente</a></td></tr></table><hr></div><div class="sect1" lang="es"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="otros_servicios_que_puede_prestar_el_servidor"></a>6. Otros servicios que puede prestar el servidor</h2></div></div></div><div class="sect2" lang="es"><div class="titlepage"><div><div><h3 class="title"><a name="cuotas"></a>6.1. Cuotas</h3></div></div></div><p>
      Pueden emplearse cuotas para limitar el espacio en disco y la
      cantidad de archivos que un usuario o un grupo puede tener.
    </p><p>
      Para usarlo debe: (1) especificar sistemas de archivos en los que
      se usará cuota (2) especificar cuota por usuario o grupo y (3)
      activar chequeo de cuota durante el arranque.
    </p><p>
      Indique los sistemas de archivos en los que usará cuota, en
      <code class="literal">/etc/fstab</code> agregando como opción del sistema de
      archivos: <code class="literal">userquota</code> y/o
      <code class="literal">groupquota</code>. Por ejemplo:
    </p><pre class="programlisting">
    /dev/wd0d /home ffs rw,nodev,nosuid,userquota 1 2
</pre><p>
      Después active el sistema de cuotas con:
    </p><pre class="programlisting">
    doas quotaon -a
</pre><p>
      Para especificar la cuota por usuario o por grupo emplee
      <code class="literal">edquota</code>, por ejemplo:
    </p><pre class="programlisting">
    doas edquota pabram
</pre><p>
      que lo dejará en un editor en el que podrá cambiar las
      especificaciones de la cuota en cada sistema de archivos con
      cuotas:
    </p><pre class="programlisting">
    Quotas for user pabram:
    /home: blocks in use: 1292980, limits (soft = 1000000, hard = 2000000)
        inodes in use: 142318, limits (soft = 0, hard = 0)
</pre><p>
      el límite blando podrá extenderse para cada usuario por un periodo
      de tiempo (en este ejemplo), tras el cual se convertirá en un
      límite duro. Límites en 0 indican que no hay restricción.
    </p><p>
      Puede replicar la configuración de cuotas en otros usuarios con:
    </p><pre class="programlisting">
    doas edquota -p pabram pedgar juamar margo
</pre><p>
      Después de especificar las cuotas de los usuarios puede verificar
      la política de cuotas con:
    </p><pre class="programlisting">
    repquota -a
</pre><p>
      o chequear que se cumplan todas las cuotas con:
    </p><pre class="programlisting">
    quotacheck -a
</pre><p>
      Para activar sistema de cuotas y que las cuotas sean verificadas
      cada vez que el sistema inicia agregue la siguiente línea al
      archivo <code class="literal">/etc/rc.conf.local</code>:
    </p><pre class="programlisting">
    check_quotas=YES
</pre><div class="sect3" lang="es"><div class="titlepage"><div><div><h4 class="title"><a name="referencias-quota"></a>6.1.1. Referencias y lecturas recomendadas</h4></div></div></div><p>
        Las siguientes páginas del manual de OpenBSD: quota 1, edquota
        8, quotaon 8, quotaoff 8, quotacheck 8 y repquota 8. En el FAQ
        de OpenBSD hay una sección sobre quotas:
        <a href="http://www.openbsd.org/faq/faq10.html#Quotas" target="_top">http://www.openbsd.org/faq/faq10.html#Quotas</a>
      </p></div></div><div class="sect2" lang="es"><div class="titlepage"><div><div><h3 class="title"><a name="postgresql"></a>6.2. Motor de bases de datos PostgreSQL</h3></div></div></div><p>
      PostgreSQL es un motor de bases de datos relacionales (RDBMS) que
      verifica integridad referencial con gran funcionalidad como base
      de datos, aunque un poco más lenta que otros motores. Su licencia
      es tipo BSD. En esta sección describimos brevemente la instalación
      y uso en un sistema adJ.
    </p><div class="sect3" lang="es"><div class="titlepage"><div><div><h4 class="title"><a name="primera-instalacion"></a>6.2.1. Primera instalación del servidor</h4></div></div></div><p>
        Este motor de bases de datos se instala con el archivo de
        ordenes <code class="literal">/inst-adJ.sh</code> que en instalaciones
        tipicas de adJ basta ejecutar y volver a ejecutar para
        actualizar o para volver a inicializar PostgreSQL u otro paquete
        de esta distribución. En caso de actualizar este archivo sacará
        respaldo de la información de la base de 2 formas (copiando
        directorios de PostgreSQL y sacando un volcado de toda la base).
      </p><p>
        A continuación se dan detalles del proceso de instalación y uso
        de PostgreSQL en caso de que requiera instalar por su cuenta o
        aprender más sobre este motor de bases de datos.
      </p><p>
        Para emplearlo por primera vez instale el paquete
        `<code class="literal">(también es recomendable</code>postgresql-docs`).
      </p><p>
        Este paquete deja instrucciones específicas para inicializar la
        base de datos, permitir conexiones de red e inicializar la base
        de datos cada vez que arranque el sistema en:
        <code class="literal">/usr/local/share/doc/postgresql/README.OpenBSD</code>.
        Los pasos que este escrito describe son:
      </p><div class="itemizedlist"><ul type="disc"><li><p>
            Opcional. El paquete de PostgreSQL disponible crea el
            usuario del sistema <code class="literal">_postgresql</code>, sin
            embargo si está actualizando o lo requiere puede crearlo
            con:
          </p><pre class="programlisting">
    doas useradd -c "Administrador de PostgreSQL" -g =uid -m -d /var/postgresql \
    -s /bin/sh -u 503 _postgresql 
    doas passwd _postgresql
</pre></li><li><p>
            A diferencia de versiones anteriores, este paquete ya no
            inicializa la base. Inicialicela con:
          </p><pre class="programlisting">
    doas mkdir -p /var/postgresql/data
    doas chown -R _postgresql:_postgresql /var/postgresql
    doas su - _postgresql
    initdb -D /var/postgresql/data -Upostgres --encoding=ISO8859-1
</pre><p>
            En adJ se emplea por defecto autenticación md5, que requiere
            suministrar clave cada vez que se carga la interfaz
            <code class="literal">psql</code> o abre conexiones. Si no desea
            autenticación md5, al inicializar la base con
            <code class="literal">initdb</code> emplee la opción
            <code class="literal">--auth=trust</code>. Una vez inicializada puede
            cambiar de un método a otro en el archivo
            <code class="literal">/var/postgresql/data/pg_hba.conf</code>
          </p></li><li><p>
            Altamente Recomendado. Agregue a
            <code class="literal">/etc/sysctl.conf</code>:
          </p><pre class="programlisting">
    kern.seminfo.semmni=256
    kern.seminfo.semmns=2048
    kern.shminfo.shmmax=50331648
</pre></li><li><p>
            Configurar servicio para que inicie en el arranque y se
            detenga al apagar. En <code class="literal">/etc/rc.conf.local</code>
            agregue:
          </p><pre class="programlisting">
    pg_ctl_flags="start \
        -D /var/postgresql/data -l /var/postgresql/logfile \
        -o '-D /var/postgresql/data'"
</pre><p>
            y en el mismo archivo en la línea donde se define
            <code class="literal">pkg_scripts</code> agregue postgresql, así un
            computador donde estén configuradas las particiones
            cifradas, respaldo cifrado y los servicios httpd, cupsd
            dirá:
          </p><pre class="programlisting">
    pkg_scripts="cron montaencres montaencpos postgresql httpd cupsd"
</pre></li></ul></div><p>
        Inicialmente el servidor queda configurado con sockets Unix
        (solo desde la misma máquina). Puede comprobar que está
        corriendo el servidor (postmaster) con:
      </p><pre class="programlisting">
    pgrep post
</pre><p>
        y revisar el socket examinando la presencia del archivo
        <code class="literal">/var/www/tmp/.s.PGSQL.5432</code> (otra ubicación
        puede ser <code class="literal">/tmp/.s.PGSQL.5432</code>).
      </p><p>
        Para emplear el protocolo TCP/IP para conexiones desde algunas
        máquinas de su elección, edite
        <code class="literal">/var/postgresql/data/pg_hba.conf</code> y agregue
        por ejemplo máquinas y usuarios que puedan hacer conexiones.
        También edite
        <code class="literal">/var/postgresql/data/postgresql.conf</code> para que
        incluya líneas de configuración como:
      </p><pre class="programlisting">
    max_connections = 100
    port = 5432
</pre><p>
        Para mejorar desempeño especialmente en sitios que atiendan
        bastantes conexiones simultáneamente, consulte primero
        <code class="literal">/usr/local/share/doc/postgresql/README.OpenBSD</code>.
      </p><p>
        En adJ por seguridad (e.g cuando ejecuta Apache con
        <code class="literal">chroot</code> en <code class="literal">/var/www</code>) no se
        permiten conexiones TCP/IP y se emplea una ruta para los sockets
        diferente a la ruta por defecto (i.e <code class="literal">/tmp</code>),
        se trata de <code class="literal">/var/www/tmp</code>, que se define en el
        archivo de configuración de PostgreSQL con:
      </p><pre class="programlisting">
    unix_socket_directory = '/var/www/tmp'
</pre><p>
        Antes de reiniciar PostgreSQL asegúrese de crear el directorio:
      </p><pre class="programlisting">
    doas mkdir  /var/www/tmp
    doas chmod a+w /var/www/tmp
    doas chmod +t /var/www/tmp
</pre><p>
        También tenga en cuenta que las diversas herramientas reciben
        como parámetro adicional <code class="literal">-h ruta</code>. Por ejemplo
        si ejecuta Apache con <code class="literal">chroot</code> en
        <code class="literal">/var/www/</code> puede tener configurado su
        directorio para sockets en <code class="literal">/var/www/tmp</code>, en
        ese caso puede iniciar <code class="literal">psql</code> con la base
        <code class="literal">prueba</code> usando:
      </p><pre class="programlisting">
    psql -h /var/www/tmp prueba
</pre><p>
        En paquetes anteriores al de adJ 4.1 el superusuario de la base
        coincidía con el usuario del sistema
        <code class="literal">_postgresql</code>, desde 4.1 el superusuario de la
        base es <code class="literal">postgres</code>, así que para realizar
        operaciones debe agregarse la opción
        <code class="literal">-U postgres</code>. El instalador de adJ
        seleccionará una clave con el programa <code class="literal">apg</code> y
        la dejará en el archivo
        <code class="literal">/var/postgresql/.pgpass</code> en una línea de la
        forma:
      </p><pre class="programlisting">
    *:*:*:postgres:clave
</pre><p>
        De esta manera desde la cuenta <code class="literal">_postgresql</code> no
        necesitará dar la clave del usuario <code class="literal">postgres</code>.
      </p></div><div class="sect3" lang="es"><div class="titlepage"><div><div><h4 class="title"><a name="autenticacion"></a>6.2.2. Habilitando autenticación</h4></div></div></div><p>
        Por defecto la forma de inicializar PostgreSQL no establecerá
        una clave de administrador ni exigirá autenticación para cuentas
        que se conecten desde la misma máquina. Sin embargo esto debe
        mejorarse si tiene varias cuentas en el mismo servidor.
      </p><p>
        Una manera es en el momento de la inicialización de la base de
        datos con las opciones <code class="literal">--auth</code> y
        <code class="literal">--pwfile</code> o <code class="literal">-W</code> de
        <code class="literal">initdb</code>, por ejemplo:
      </p><pre class="programlisting">
    su - _postgresql
    echo "MiClave" &gt; clave.txt
    initdb -Upostgres --auth=md5 --pwfile=clave.txt -D/var/postgresql/data
</pre><p>
        que inicializará PostgreSQL con autenticación md5 y clave de
        administrador <code class="literal">MiClave</code>
      </p><p>
        Otra posibilidad es cambiar la configuración después de haber
        inicializado sin autenticación. Para esto cambie la clave del
        administrador con<sup>[<a name="idm44863568" href="#ftn.idm44863568">29</a>]</sup>:
      </p><pre class="programlisting">
    psql -U postgres template1 
    template1=# alter user postgres with password 'MiClave';
</pre><p>
        Después edite
        <code class="literal">/var/postgresql/data/pg_hba.conf</code> y cambie en
        las lineas de acceso la palabra <code class="literal">trusted</code> por
        <code class="literal">md5</code>, por ejemplo:
      </p><pre class="programlisting">
    local   all         all                               md5
    host    all         all         127.0.0.1/32          md5
    host    all         all         ::1/128               md5
</pre><p>
        Detenga el servidor y vuelvalo a iniciar, notará que todo
        intento de ingreso exige la clave.
      </p><p>
        El listado de bases de datos puede consultarse con:
      </p><pre class="programlisting">
    SELECT * FROM pg_database ;
</pre><p>
        y el listado de los usuarios con:
      </p><pre class="programlisting">
    SELECT username FROM pg_users;
</pre><p>
        Las claves de los diversos usuarios pueden cambiarse de forma
        análoga a la presentada para <code class="literal">postgres</code>:
      </p><pre class="programlisting">
    ALTER ROLE EUSUARIO with UNENCRYPTED PASSWORD 'clave-plana';
</pre><p>
        Desde PostgreSQL 8.1 se emplea un esquema de roles que unifica
        los conceptos de usuario y grupo. Además de exigir clave para
        cada ingreso, cada rol de PostgreSQL que crea objetos puede
        modificar permisos para restringir o dar acceso a otros roles.
        Por ejemplo para restringir el acceso a una tabla
        <code class="literal">cuenta</code>:
      </p><pre class="programlisting">
    REVOKE ALL ON cuenta FROM PUBLIC;
</pre><p>
        Cuando un rol crea una base de datos, queda como dueño de todas
        las tablas y en principio es el único que puede acceder a estas.
        Otro rol en principio no podrá ni siquiera examinar los datos de
        las tablas:
      </p><pre class="programlisting">
    SELECT * FROM solicitud;
    ERROR:  permission denied for relation solicitud
</pre><p>
        Para dar permiso a otro rol puede usarse:
      </p><pre class="programlisting">
    GRANT ALL on solicitud TO EUSUARIO2;
</pre></div><div class="sect3" lang="es"><div class="titlepage"><div><div><h4 class="title"><a name="creacion-base"></a>6.2.3. Creación de una base de datos</h4></div></div></div><p>
        Para crear la base de datos <code class="literal">prueba</code> puede usar
        el superusuario con la opción <code class="literal">-U postgres</code> o
        desde una cuenta que tenga permiso para crear bases de datos:
      </p><pre class="programlisting">
    createdb prueba
    psql prueba
</pre><p>
        Desde la interfaz <code class="literal">psql</code>, pueden darse comandos
        SQL y otros específicos de PostgreSQL (ver
        <a href="otros_servicios_que_puede_prestar_el_servidor.html#uso-base" title="6.2.4. Uso de una base de datos">Uso de una base de datos</a>). En
        particular el usuario <code class="literal">postgres</code> y desde
        cuentas con permiso para crear usuarios, puede crear otros
        usuarios (globales para todas las bases de datos manejadas por
        el servidor). Por ejemplo para crear un usuario normal sin
        clave, desde <code class="literal">psql</code> ingresar:
      </p><pre class="programlisting">
    CREATE USER usejemplo
</pre><p>
        El comando <code class="literal">CREATE USER</code> presentado puede ir
        seguido de <code class="literal">CREATEUSER</code> para crear un
        superusuario (sin restricción alguna), o
        <code class="literal">CREATEDB</code> para crear un usuario que pueda
        crear bases de datos o <code class="literal">PASSWORD 'clave'</code> para
        crear un usuario con una clave (emplea autenticación
        configurada). Desde la línea de comandos puede crearse un
        usuario con:
      </p><pre class="programlisting">
    createuser usejemplo
</pre><p>
        Para eliminar un usuario desde <code class="literal">psql</code> se usa:
      </p><pre class="programlisting">
    DROP USER usejemplo;
</pre><p>
        y para eliminarlo desde línea de comandos:
      </p><pre class="programlisting">
    dropuser usejemplo
</pre><p>
        Puede ejecutarse un script SQL (<code class="literal">crea.sql</code>)
        desde la línea de comandos a un base de datos con
      </p><pre class="programlisting">
    psql -d test -U ejusuario --password -f crea.sql
</pre></div><div class="sect3" lang="es"><div class="titlepage"><div><div><h4 class="title"><a name="uso-base"></a>6.2.4. Uso de una base de datos</h4></div></div></div><p>
        Puede emplear <code class="literal">psql</code>, la interfaz texto que
        acepta comandos SQL y que se distribuye con PostgreSQL. Para
        esto, entre a una base (digamos <code class="literal">b1908</code>) como
        un usuario (digamos <code class="literal">u1908</code>) con:
      </p><pre class="programlisting">
    psql -U u1908 -d b1908
</pre><p>
        En esta interfaz puede dar comandos SQL y algunos comandos
        internos que puede listar con <code class="literal">\h</code>. Algunos
        ejemplos de operaciones útiles son:
      </p><div class="variablelist"><dl><dt><span class="term">
            <code class="literal">\dt</code>
          </span></dt><dd><p>
              para ver tablas disponibles.
            </p></dd><dt><span class="term">
            <code class="literal">\d usuarios</code>
          </span></dt><dd><p>
              Describe la estructura de la tabla
              <code class="literal">usuarios</code>
            </p></dd><dt><span class="term">
            <code class="literal">SELECT victim_nombre,victim_apellido FROM victimas WHERE victim_edad&lt;=12;</code>
          </span></dt><dd><p>
              Que muestre los nombres de niños de 12 años o menos
              listados en la tabla <code class="literal">victimas</code>
            </p></dd><dt><span class="term">
            <code class="literal">\h update</code>
          </span></dt><dd><p>
              Da ayuda sobre el comando <code class="literal">update</code> (que
              permite actualizar registros de una tabla.)
            </p></dd></dl></div><p>
        Es recomendable que los usuarios del sistema que también son
        usuarios de PostgreSQL creen el archivo
        <code class="literal">~/.pgpass</code> donde puede almacenarse la clave
        que usa en PostgreSQL ---de forma que las diversas herramientas
        no la solicitaran--- con una línea de la forma:
      </p><pre class="programlisting">
    *:*:*:usuario:clave
</pre></div><div class="sect3" lang="es"><div class="titlepage"><div><div><h4 class="title"><a name="postgresql-cotejacion"></a>6.2.5. Cotejación en PostgreSQL</h4></div></div></div><p>
        Desde adJ 5.2 se incluye un porte de PostgreSQL (la versión
        incluida en adJ VER-ADJ es P-POSTGRESQL-SERVER) que soporta
        cotejaciones de acuerdo al locale, y por defecto se crean
        cotejaciones para todos los países de habla hispana, con nombres
        de la forma <code class="literal">es_CO_UTF_8</code>. Donde
        <code class="literal">CO</code> representa Colombia, pero se pueden
        emplear otras abreviaturas de países como se usan en Internet
        (estándar ISO-3166-1): ES CO PE VE EC GT CU BO HN PY SV CR PA GQ
        MX AR CH DO NI UY PR.
      </p><p>
        Puede examinar las cotejaciones disponibles ingresando al
        interprete <code class="literal">psql</code> y ejecutando:
      </p><pre class="programlisting">
    SELECT * FROM pg_collation;
</pre><p>
        Puede crear una cotejación (digamos <code class="literal">esp</code>) para
        un locale soportado por el sistema operativo y con la misma
        codificación de su base de datos (digamos
        <code class="literal">es_CO.ISO8859-1</code>) con:
      </p><pre class="programlisting">
    CREATE COLLATION esp (LOCALE='es_CO.ISO8859-1');
</pre><p>
        Una vez creada puede realizar operaciones empleándola por
        ejemplo:
      </p><pre class="programlisting">
    SELECT 'Á' &lt; 'B' COLLATE "esp";
    ...
    SELECT nombre FROM clase ORDER BY nombre COLLATE "esp";
</pre><p>
        la primera sentencia dará:
      </p><pre class="programlisting">
    ?column? 
    ----------
    t
    (1 row)
</pre><p>
        Puede crear columnas de tablas especificando el tipo de
        cotejación por defecto para operaciones con esa columna.
      </p><pre class="programlisting">
    CREATE TABLE ejc (
    nombre VARCHAR(100) COLLATE "esp"
    );
</pre><p>
        o cambiar las existentes:
      </p><pre class="programlisting">
    ALTER TABLE clase ALTER nombre TYPE VARCHAR(500) COLLATE "esp";
</pre><p>
        También podrá renombrar cotejaciones que haya creado con
        <code class="literal">ALTER COLLATION esp RENAME TO es_CO_ISO8859_1;</code>,
        así como borrarlas con <code class="literal">DROP COLLATION esp;</code>.
        Puede consultar más en
        <a href="http://www.postgresql.org/docs/9.1/static/collation.html" target="_top">http://www.postgresql.org/docs/9.1/static/collation.html</a>.
      </p></div><div class="sect3" lang="es"><div class="titlepage"><div><div><h4 class="title"><a name="respaldo-postgresql"></a>6.2.6. Copias de respaldo</h4></div></div></div><p>
        Para sacar una copia de respaldo de todas las base de datos
        manejadas con PostgreSQL (y suponiendo que el socket está en
        <code class="literal">/var/www/tmp</code>): ingrese a la cuenta del
        administrador:
      </p><pre class="programlisting">
    doas su - _postgresql
    pg_dumpall -U postgres -h /var/www/tmp/ \
        --inserts --attribute-inserts &gt; /respaldos/pgdump.sql
</pre><p>
        Puede restablecer una copia con
      </p><pre class="programlisting">
    psql -U postgres -h /var/www/tmp/ \
        -f /respaldos/pgdump.sql template1
</pre></div><div class="sect3" lang="es"><div class="titlepage"><div><div><h4 class="title"><a name="referencias-postgresql"></a>6.2.7. Referencias y lecturas recomendadas</h4></div></div></div><div class="itemizedlist"><ul type="disc"><li><p>
            Documentación del paquete postgresql (README.OpenBSD,
            INSTALL).
          </p></li><li><p>
            Documentación disponible en el paquete
            <code class="literal">postgresql-doc</code> (ver postgresql-doc) y en
            <a href="http://www.postgresql.org/docs" target="_top">http://www.postgresql.org/docs</a>.
          </p></li><li><p>
            Páginas del manual de Unix: psql 1
          </p></li></ul></div></div></div><div class="sect2" lang="es"><div class="titlepage"><div><div><h3 class="title"><a name="mariadb"></a>6.3. MariaDB</h3></div></div></div><p>
      A partir de OpenBSD/adJ 5.7 MariaDB remplaza a MySQL. Según
      <a href="https://es.wikipedia.org/wiki/MariaDB" target="_top">https://es.wikipedia.org/wiki/MariaDB</a>
      MariaDB fue iniciada por el fundador de MySQL después de que
      Oracle compró Sun y MySQL, pues consideraba que Oracle había hecho
      la compra para reducir competencia de sus bases de datos.
    </p><p>
      Debe instalar los paquetes P-MARIADB-CLIENT y P-MARIADB-SERVER.
      Aunque el nombre de los paquetes cambia los comandos para operarla
      siguen siendo los mismos. Tras instalar el servidor debe ejecutar
      <code class="literal">mysql_install_db</code>.
    </p><p>
      Inicialice el directorio donde estarán las bases de datos con
    </p><pre class="programlisting">
    doas /usr/local/bin/mysql_install_db
</pre><p>
      Para aumentar el límite de archivos que el usuario
      <code class="literal">_mysql</code> de clase <code class="literal">mysql</code> puede
      abrir agregue a <code class="literal">/etc/login.conf</code>:
    </p><pre class="programlisting">
    mysql:\
        :openfiles-cur=2048:\
        :openfiles-max=4096:\
        :tc=daemon:
</pre><p>
      tenga en cuenta no dejar espacios al final de cada línea y que
      desde la segunda línea cada una comiencen con el caracter
      tabulador. A continuación regenere el archivo binario
      <code class="literal">/etc/login.conf.db</code> con
    </p><pre class="programlisting">
    cd /etc
    doas cap_mkdb /etc/login.conf 
</pre><p>
      Después agregue <code class="literal">mysqld</code> a
      <code class="literal">pkg_scripts</code> en
      <code class="literal">/etc/rc.conf.local</code>. A continuación lance el
      servidor con:
    </p><pre class="programlisting">
    doas sh /etc/rc.d/mysqld start
</pre><p>
      Los errores quedarán en <code class="literal">/var/mysql/host.err</code>.
    </p><p>
      Después puede establecer una clave para el usuario
      <code class="literal">root</code> de MariaDB cuando ingresa desde
      <code class="literal">localhost</code> con:
    </p><pre class="programlisting">
    /usr/local/bin/mysqladmin -u root  password 'nueva-clave' 
    /usr/local/bin/mysqladmin -u root -pnueva-clave -h ESERV password 'nueva-clave'
    
</pre><p>
      Después puede iniciar una sesión, crear bases de datos, crear
      usuarios y otorgarles privilegios.
    </p><p>
      Para apagar el servidor mysql:
    </p><pre class="programlisting">
    mysqladmin -u root -p shutdown
    
</pre><p>
      Si desea usar mysql con php, instale además de los paquetes
      básicos de php (<code class="literal">php-core-v</code> y
      <code class="literal">php-mysql-v</code>)
    </p><div class="sect3" lang="es"><div class="titlepage"><div><div><h4 class="title"><a name="uso-mariadb"></a>6.3.1. Uso básico</h4></div></div></div><pre class="programlisting">
    mysql -u root -p 
</pre><p>
        puede crear la base de datos <code class="literal">datos</code>, y un
        usuario <code class="literal">erfurt</code> que la pueda administrar (i.e
        con todos los privilegios excepto GRANT) y con clave
        <code class="literal">vsewf</code> usando:
      </p><pre class="programlisting">
    CREATE DATABASE datos;
    GRANT ALL PRIVILEGES ON datos.* TO erfurt@localhost IDENTIFIED BY 'vsewf';
</pre><p>
        Algunas operaciones usuales del administrador son:
      </p><pre class="programlisting">
    SHOW DATABASES;
</pre><p>
        que muestra todas las bases disponibles.
      </p><pre class="programlisting">
    USE base1;
</pre><p>
        que permite usar la base base1.
      </p><pre class="programlisting">
    SHOW TABLES;
</pre><p>
        que muestra todas las tablas de la base activa.
      </p><pre class="programlisting">
    DESCRIBE tabla;
    SHOW CREATE TABLE tabla;
</pre><p>
        que presentan estructura de la tabla.
      </p></div><div class="sect3" lang="es"><div class="titlepage"><div><div><h4 class="title"><a name="clave-mysql"></a>6.3.2. Cambio de la clave de administrador</h4></div></div></div><p>
        Si olvida la clave de root después de haberla establecido puede
        cambiarla entrando a la cuenta de administrador:
      </p><div class="itemizedlist"><ul type="disc"><li><p>
            Detenga el servidor.
          </p></li><li><p>
            Inicie el servidor con
            <code class="literal">/usr/local/libexec/mysqld --user=root --skip-grant-tables</code>
          </p></li><li><p>
            Ejecute:
          </p><pre class="programlisting">
    # mysql
    mysql&gt; USE mysql
    mysql&gt; UPDATE USER SET PASSWORD=password('miclave') WHERE user='root';
    mysql&gt; FLUSH PRIVILEGES;
    mysql&gt; EXIT
</pre></li><li><p>
            Vuelva a apagar el servidor y reinicielo con:
            <code class="literal">/usr/local/bin/mysqld_safe &amp;</code>
          </p></li></ul></div></div><div class="sect3" lang="es"><div class="titlepage"><div><div><h4 class="title"><a name="recuperacion-backups"></a>6.3.3. Recuperación y backups</h4></div></div></div><p>
        MariaDB mantiene bases de datos en directorios y las tablas en
        archivos. No es recomendable que modifique tales archivos, al
        menos no, mientras el servidor esté activo.
      </p><p>
        Para sacar una copia de respaldo de todas las bases de datos
        con:
      </p><pre class="programlisting">
    mysqldump --force -p --all-databases &gt; /respaldomysql/dump-1nov2007.sql
</pre><p>
        y posteriormente restaurarla con:
      </p><pre class="programlisting">
    mysql &lt; /respaldomysql/dump-1nov2007.sql
</pre></div><div class="sect3" lang="es"><div class="titlepage"><div><div><h4 class="title"><a name="chroot-mysql"></a>6.3.4. MariaDB y servidor web con chroot</h4></div></div></div><p>
        Puede emplear aplicaciones para Apache en modo
        <code class="literal">chroot</code> que usen bases de datos MariaDB de
        tres formas: (1) Conectándose a un puerto TCP/IP donde responda
        MariaDB, (2) poniendo el socket de MariaDB en un directorio
        dentro de la jaula del servidor web o (3) Corriendo MariaDB
        dentro de la jaula <code class="literal">chroot</code> (ver
        <a href="http://structio.sourceforge.net/guias/servidor_OpenBSD/mysql.html#mysql-chroot" target="_top">http://structio.sourceforge.net/guias/servidor_OpenBSD/mysql.html#mysql-chroot</a>).
      </p><p>
        Para correro MariaDB dentro de A continuación documentamos como
        ubicar el socket de MariaDB dentro de la jaula del servidor web
        (/var/www/).
      </p><p>
        Una vez instale <code class="literal">maria-server</code> cree el
        directorio en el cual ubicará el socket, digamos:
      </p><pre class="programlisting">
    mkdir -p /var/www/var/run/mysql/
    chown _mysql:_mysql /var/www/var/run/mysql/
    chmod a+w /var/www/var/run/mysql/
    chmod +t /var/www/var/run/mysql/
</pre><p>
        y después inicie MariaDB indicando la ruta del socket con la
        opción <code class="literal">--socket</code>, por ejemplo para que el
        cambio se efectúe en cada inicio, edite
        <code class="literal">/etc/rc.conf.local</code> para agregar:
      </p><pre class="programlisting">
    mysqld_flags="--socket=/var/www/var/run/mysql/mysql.sock"
</pre><p>
        e inicie desde <code class="literal">/etc/rc.local</code> con:
      </p><pre class="programlisting">
    pgrep mysqld &gt; /dev/null
    if [ "$?" != 0  -a X"${mysqld_flags}" != X"NO" -a \
        -x /usr/local/bin/mysqld_safe ]; then
        echo -n ' mysqld ' 
        /usr/local/bin/mysqld_safe ${mysqld_flags} &amp;
    fi
</pre><p>
        Sus aplicaciones PHP pueden entonces conectarse con:
      </p><pre class="programlisting">
    $dbhost  = "localhost";
    $dbuname = "miusuario";
    $dbpass  = "miclave";
    mysql_connect($dbhost, $dbuname, $dbpass);
</pre><p>
        Tenga en cuenta también que otros binarios de MariaDB también
        requerirán la opción
        <code class="literal">--socket=/var/www/var/run/mysql/mysql.sock</code> al
        ejecutarse por ejemplo:
      </p><pre class="programlisting">
    mysqldump --socket=/var/www/var/run/mysql/mysql.sock  
        \-p --all-databases
    
</pre></div><div class="sect3" lang="es"><div class="titlepage"><div><div><h4 class="title"><a name="lecutras-mysql"></a>6.3.5. Lecturas recomendadas</h4></div></div></div><p>
        Referencias:
      </p><div class="itemizedlist"><ul type="disc"><li><p>
            Una explicación de algo de la instalación y el uso de MySQL
            en OpenBSD:
            <a href="http://www.sancho2k.net/filemgmt_data/files/mysql_notes.html" target="_top">http://www.sancho2k.net/filemgmt_data/files/mysql_notes.html</a>
          </p></li><li><p>
            La documentación de MariaDB :
            <a href="https://mariadb.com/kb/en/mariadb/documentation/" target="_top">https://mariadb.com/kb/en/mariadb/documentation/</a>
          </p></li><li><p>
            Ayuda para cambiar clave de root en sistemas Linux:
            <a href="http://www.netadmintools.com/art90.html" target="_top">http://www.netadmintools.com/art90.html</a>
          </p></li></ul></div></div></div><div class="sect2" lang="es"><div class="titlepage"><div><div><h3 class="title"><a name="ldapd"></a>6.4. Servidor ldapd</h3></div></div></div><p>
      LDAP (Lightweight Directory Access Protocol) es un protocolo para
      mantener e intercambiar información almacenada en directorios (i.e
      bases de datos especiales), su versión 3 se define en los RFC
      2251, 2256, 2829, 2830 y 3377.
    </p><p>
      Un uso típico de LDAP es mantener en un servidor información de
      los usuarios de una organización para permitir su autenticación en
      otros servicios (e.g nombres, apellidos, dirección, teléfono,
      login, clave).
    </p><p>
      OpenBSD incluye (desde OpenBSD 4.8) un servidor para LDAP versión
      3, <code class="literal">ldapd</code>. No incluye cliente para LDAP pero
      desde la línea de comandos puede emplearse el paquete
      <code class="literal">openldap-client</code> o como interfaz web
      <code class="literal">phpldapadmin</code><sup>[<a name="idm382510160" href="#ftn.idm382510160">30</a>]</sup>.
    </p><div class="sect3" lang="es"><div class="titlepage"><div><div><h4 class="title"><a name="instalacion-ldapd"></a>6.4.1. Instalación de ldapd</h4></div></div></div><p>
        No necesita instalar paquetes para la operación como servidor.
      </p><p>
        La configuración que se presenta emplea LDAPS para conexiones en
        la red local, empleando un certificados cuyas llaves pública y
        privada debe copiarse a <code class="literal">/etc/ldap/certs</code> y
        ejecutar:
      </p><pre class="programlisting">
    cd /etc/ldap/certs
    chown _ldapd:_ldapd *
    chmod 0640 /etc/ldap/certs/*key
    chmod 0644 /etc/ldap/certs/*crt 
</pre><p>
        Para configurar el servidor, verifique que exista el usuario
        <code class="literal">_ldapd</code> y el grupo <code class="literal">_ldapd</code> y
        edite <code class="literal">/etc/ldapd.conf</code>:
      </p><pre class="programlisting">
    schema "/etc/ldap/core.schema"                                                  
    schema "/etc/ldap/inetorgperson.schema"                                         
    schema "/etc/ldap/nis.schema"                                                   
     
    lan_if = "re1"
    
    listen on $lan_if ldaps certificate www.pasosdeJesus.org
    listen on lo0 secure
    listen on "/var/run/ldapi"
    
    namespace "dc=www,dc=pasosdeJesus,dc=org" {
            rootdn          "cn=root,dc=www,dc=pasosdeJesus,dc=org"
            rootpw          "secret"
            index           sn
            index           givenName
            index           cn
            index           mail
            index           objectClass
            index           sn
            fsync           on
    }                                                                               
</pre><p>
        Recuerde que la clave del directorio debe ser mejor que la
        presentada (i.e remplace <code class="literal">secret</code> por una buena
        clave). En lugar de poner la clave plana también es posible
        poner la cadena generada con:
      </p><pre class="programlisting">
    doas slappasswd -v -u -h {CRYPT} -s secret
</pre><p>
        que en el caso de la clave '<code class="literal">secret</code>' es
        '<code class="literal">{CRYPT}uPUCy906TIu/k</code>'
      </p><p>
        La configuración por defecto emplea
        <code class="literal">/var/db/ldap</code> como directorio para mantener
        las bases de datos y mantiene una por cada espacio de nombres
        (namespace). Las conexiones no cifradas por defecto operan en el
        puerto 389 y deben autenticarse con SASL (a menos que tengan la
        opción <code class="literal">secure</code> para permitir autenticación
        plana) y las que empleen certificado iran cifradas en el puerto
        636.
      </p><p>
        Cada vez que modifique el archivo de configuración del servidor,
        puede verificarlo con:
      </p><pre class="programlisting">
    doas ldapd -n
</pre><p>
        Para iniciar el servidor LDAP en modo de depuración para ver
        posibles errores:
      </p><pre class="programlisting">
    doas ldadpd -dv
</pre><p>
        Tras verificar el funcionamiento, para que en cada arranque se
        inicie el servidor puede agregar a
        <code class="literal">/etc/rc.conf.local</code>:
      </p><pre class="programlisting">
    ldapd_flags=""
    pkg_scripts = "ldapd"
</pre><p>
        E iniciar el servicio con
        <code class="literal">/etc/rc.d/ldapd start</code> y detenerlo con
        <code class="literal">/etc/rc.d/ldadp stop</code>
      </p><p>
        Es muy recomendable que agregue el esquema LDAP de Courier, de
        esta forma tomada de {3}:
      </p><div class="itemizedlist"><ul type="disc"><li><p>
            Descarguelo y renombrelo:
          </p><pre class="programlisting">
    doas ftp -o /etc/ldap/courier.schema \
    http://courier.cvs.sourceforge.net/viewvc/courier/libs/authlib/authldap.schema
</pre></li><li><p>
            Edite /etc/ldap/courier.schema y quite comentario a las
            líneas:
          </p><pre class="programlisting">
    attributetype ( 1.3.6.1.4.1.10018.1.1.14 NAME 'mailhost'                        
            DESC 'Host to which incoming POP/IMAP connections should be proxied'
            EQUALITY caseIgnoreIA5Match                                        
            SYNTAX 1.3.6.1.4.1.1466.115.121.1.26{256} )  
</pre></li><li><p>
            Reinicie ldapd
          </p></li></ul></div></div><div class="sect3" lang="es"><div class="titlepage"><div><div><h4 class="title"><a name="pruebas-openldap"></a>6.4.2. Pruebas Iniciales con openldap-client</h4></div></div></div><p>
        Instale el paquete con:
      </p><pre class="programlisting">
    doas pkg_add openldap-client
</pre><p>
        Verifique localmente que el servidor no cifrado corre con:
      </p><pre class="programlisting">
    ldapsearch -x -b 'dc=www,dc=pasosdeJesus,dc=org' '(objectclass=*)'
</pre><p>
        Respecto al servidor cifrado puede analizar la conexión SSL con:
      </p><pre class="programlisting">
    openssl s_client -connect 192.168.2.1:465
</pre><p>
        Puede verificar sus certificados contra la entidad que los
        expide siguiendo instrucciones de {4}.
      </p><p>
        Puede deshabilitar la verificación de certificados de ldapsearch
        poniendo en <code class="literal">/etc/openldap/ldap.conf</code>:
      </p><pre class="programlisting">
    TLS_REQCERT never
</pre><p>
        Para hacer pruebas desde otro computador, tenga en cuenta que en
        OpenBSD ldapsearch utiliza openssl mientras que por ejemplo en
        Ubuntu emplea GNUTLS, por esto eventualmente puede requerir
        descargar certificado de autoridad certificadora (digamos
        gd.pem) y ejecutar:
      </p><pre class="programlisting">
    doas cat /etc/ssl/certs/gd.pem &gt;&gt; /etc/ssl/certs/ca-certificates.crt 
</pre><p>
        Además de modificar <code class="literal">/etc/ldap/ldap.conf</code> para
        agregar
      </p><pre class="programlisting">
    TLS_CACERT      /etc/ssl/certs/ca-certificates.crt
</pre></div><div class="sect3" lang="es"><div class="titlepage"><div><div><h4 class="title"><a name="datos-iniciales-ldapd"></a>6.4.3. Adición de datos iniciales</h4></div></div></div><p>
        Una vez esté corriendo <code class="literal">ldapd</code> deberá iniciar
        un directorio para su organización y los usuarios que se
        autenticarán. Puede agregar estos datos con el programa
        <code class="literal">ldapadd</code> que hace parte de openldap-client.
        Programa que recibe datos en formato ldif, por ejemplo leidos de
        un archivo. Un primer archivo con datos de la organización puede
        ser <code class="literal">org.ldif</code> y contener:
      </p><pre class="programlisting">
    dn:     dc=www,dc=pasosdeJesus,dc=org
    objectClass:    dcObject
    objectClass:    organization
    o:      Pasos de Jesús
    dc:     correo

    dn: cn=admin,dc=correo,dc=pasosdeJesus,dc=org
    objectClass: organizationalRole
    cn: admin

    dn:ou=gente, dc=correo,dc=pasosdeJesus,dc=org
    objectClass:    top
    objectClass:    organizationalUnit
    ou:     gente

    dn:ou=grupos,dc=correo,dc=pasosdeJesus,dc=org
    objectClass:    top
    objectClass:    organizationalUnit
    ou:     grupos

    dn:ou=sendmail,dc=www,dc=pasosdeJesus,dc=org
    ou: sendmail
    objectClass: top
    objectClass: organizationalUnit
    userPassword: sendmail
</pre><p>
        Nota: Al agregar información verifique no dejar espacios en
        blanco al final de cada línea. Se pueden agregar
        <code class="literal">org.ldif</code> con:
      </p><pre class="programlisting">
    ldapadd -x -D "cn=admin,dc=www,dc=pasosdeJesus,dc=org" -W \
    -h www.pasosdeJesus.org -f org.ldif
</pre><p>
        Además de poder revisar los mensajes que
        <code class="literal">slapd</code> genere al ejecutarse en modo de
        depuración, podrá consultar los datos ingresados al directorio
        con:
      </p><pre class="programlisting">
    ldapsearch -x -b 'dc=www,dc=pasosdeJesus,dc=org' '(objectclass=*)'
</pre></div><div class="sect3" lang="es"><div class="titlepage"><div><div><h4 class="title"><a name="phpldapadmin"></a>6.4.4. Instalación y configuración de
      <code class="literal">phpldapadmin</code></h4></div></div></div><p>
        Instale el paquete y siga las instrucciones que de (por ejemplo
        activar <code class="literal">php-ldap</code>):
      </p><pre class="programlisting">
    doas pkg_add phpldapadmin
</pre><p>
        También debe asegurar que pueden emplearse los dispositivos de
        generación de números aleatorios en la jaula chroot de Apache
        (esto lo hace por defecto el instalador de adJ 5.5). Para esto
        verifique que en <code class="literal">/etc/fstab</code> al montar la
        partición <code class="literal">/var</code> este permitiendo dispositivos
        (que no este la opción <code class="literal">nodev</code>) y ejecute:
      </p><pre class="programlisting">
    cd /var/www
    doas mkdir -p dev
    cd dev
    /dev/MAKEDEV arandom
</pre></div><div class="sect3" lang="es"><div class="titlepage"><div><div><h4 class="title"><a name="referencias-ldapd"></a>6.4.5. Referencias y lecturas recomendadas</h4></div></div></div><div class="itemizedlist"><ul type="disc"><li><p>
            Las siguientes páginas man: ldapd 8. ldapctl 8. ldapd.conf
            5.
          </p></li><li><p>
            <a href="http://dhobsd.pasosdejesus.org/index.php?id=ldapd" target="_top">http://dhobsd.pasosdejesus.org/index.php?id=ldapd</a>.
          </p></li><li><p>
            <a href="http://www.cyberciti.biz/faq/test-ssl-certificates-diagnosis-ssl-certificate/" target="_top">http://www.cyberciti.biz/faq/test-ssl-certificates-diagnosis-ssl-certificate/</a>.
          </p></li><li><p>
            <a href="http://www.tumfatig.net/20120817/monitoring-openbsds-ldap-daemon/" target="_top">http://www.tumfatig.net/20120817/monitoring-openbsds-ldap-daemon/</a>.
          </p></li><li><p>
            <a href="http://openbsd.7691.n7.nabble.com/dev-random-as-chrooted-named-s-entropy-source-current-td64344.html" target="_top">http://openbsd.7691.n7.nabble.com/dev-random-as-chrooted-named-s-entropy-source-current-td64344.html</a>.
          </p></li></ul></div></div></div><div class="sect2" lang="es"><div class="titlepage"><div><div><h3 class="title"><a name="autoridad_certificadora"></a>6.5. Autoridad certificadora interna</h3></div></div></div><p>
      Los servicios en red (en particular ldapd, ver
      <a href="otros_servicios_que_puede_prestar_el_servidor.html#ldapd" title="6.4. Servidor ldapd">Sección 6.4, “Servidor ldapd”</a> y postgresql remoto, ver
      <a href="otros_servicios_que_puede_prestar_el_servidor.html#postgresql" title="6.2. Motor de bases de datos PostgreSQL">Sección 6.2, “Motor de bases de datos PostgreSQL”</a>) requieren cada vez más
      comunicaciones cifradas y suelen emplear SSL o TLS que requieren
      certificados públicos firmados por autoridades certificadoras.
    </p><p>
      Cada vez los programas, librerías y lenguajes están verificando
      con más insistencia que los certificados sean efectivamente
      firmados por autoridades certificadoras.
    </p><p>
      En genral las autoridades certificadoras cobran por emitir firmas
      para certificados. Sin embargo
      <a href="http://letsencrypt.org" target="_top">http://letsencrypt.org</a>
      es una autoridad certificadora que expide certificados gratuitos
      para sitios públicos pero no para sitios en redes internas por
      cuanto el proceso de expedición de certificados requiere resolver
      por DNS desde sus servidores el dominio para el cual se está
      creando el certificado. Además sus certificados son de 3 meses por
      cuanto deben renovarse cada 3 meses.
    </p><p>
      Esto hace necesario que cada organización que requiere servicios
      cifrados con SSL o TLS en su red interna (como PostgreSQL remoto o
      LDAP) cuente con su propia autoridad certificadora interna
    </p><div class="sect3" lang="es"><div class="titlepage"><div><div><h4 class="title"><a name="conceptos"></a>6.5.1. Conceptos</h4></div></div></div><p>
        Las operaciones con SSL dependen en cliente y en servidor de la
        librería LibreSSL (en otros sistemas OpenSSL). Esta incluye el
        programa openssl para hacer varias operaciones, incluyendo
        operaciones de una autoridad certificadora.
      </p><p>
        Un certificado SSL siempre se asocia a una llave privada (el
        certificado es la llave pública).
      </p><p>
        El proceso para crear un certificado es:
      </p><div class="orderedlist"><ol type="1" compact><li><p>
            Crear la llave privada para el certificado (extensión .key)
          </p></li><li><p>
            Generar el certificado (llave pública) pero sin firma
            (extensión .csr)
          </p></li><li><p>
            Firmar el certificado con una autoridad certificadora y
            generar el certificado
          </p></li><li><p>
            Usar el certificado firmado junto con la llave privada para
            realizar conexiones (el certificado firmado se compartirá,
            mientras que la llave privada no)
          </p></li></ol></div><p>
        Los archivos intermedios pueden examinarse así:
      </p><div class="itemizedlist"><ul type="disc" compact><li><p>
            Solicitudes:
            <code class="literal">openssl req -noout -text -in client.csr</code>
          </p></li><li><p>
            Llaves: <code class="literal">openssl rsa -check -in client.key</code>
          </p></li><li><p>
            Certificados:
            <code class="literal">openssl x509 -noout -text -in client.crt</code>
          </p></li></ul></div><p>
        La autoridad certificadora no es más que un certificado
        autofirmado que se configura y se usa consistentemente como
        autoridad certificadora.
      </p></div><div class="sect3" lang="es"><div class="titlepage"><div><div><h4 class="title"><a name="configuraci%C3%B3n-de-servidor"></a>6.5.2. Configuración de servidor</h4></div></div></div><p>
        Supongamos que ubicamos en
        <code class="literal">/var/postgresql/data</code> los archivos de la
        autoridad certificadora:
      </p><div class="itemizedlist"><ul type="disc" compact><li><p>
            <code class="literal">root.crt</code> Autoridad certificadora (igual a
            server.crt)
          </p></li><li><p>
            <code class="literal">root.crl</code> Lista de revocación
          </p></li><li><p>
            <code class="literal">server.crt</code> Certificado del servidor
          </p></li><li><p>
            <code class="literal">server.key</code> Llave privada del servidor
          </p></li></ul></div><p>
        Se pueden generar así (como se explica en
        <a href="https://www.howtoforge.com/postgresql-ssl-certificates" target="_top">https://www.howtoforge.com/postgresql-ssl-certificates</a>):
      </p><pre class="programlisting">
    openssl genrsa -des3 -out server.key 1024
    openssl rsa -in server.key -out server.key
    chmod 400 server.key
    chown postgres.postgres server.key
    openssl req -new -key server.key -days 3650 -out server.crt -x509 -subj '/C=CO/ST=Bogota/L=MiOng/O=MiOng/CN=miong.org.co/emailAddress=info@miong.org'
</pre></div><div class="sect3" lang="es"><div class="titlepage"><div><div><h4 class="title"><a name="generaci%C3%B3n-de-un-par-de-certificados"></a>6.5.3. Generación de un par de certificados</h4></div></div></div><p>
        LDAP requiere que el CN del certificado corresponda al nombre
        del computador en la red interna.
      </p><p>
        Los certificados para clientes de PostgreSQL requieren que el CN
        del Certificado corresponda al usuario en la base de datos.
      </p><p>
        En el computador que hará la conexión (en este ejemplo
        <code class="literal">apbd2.miong.org.co</code>) ejecute:
      </p><pre class="programlisting">
    mkdir ~/ssl
    cd ~/ssl
    openssl genrsa -des3 -out apbd2.miong.org.co.key 1024
    openssl rsa -in apbd2.miong.org.co.key -out apbd2.miong.org.co.key
</pre><p>
        De una clave temporal y borrela con
      </p><pre class="programlisting">
    openssl rsa -in apbd2.miong.org.co.key -out apbd2.miong.org.co.key
</pre><p>
        Cree la solicitud de certificado con:
      </p><pre class="programlisting">
    openssl req -new -key apbd2.miong.org.co.key -out apbd2.miong.org.co.csr -subj '/C=CO/ST=Cundinamarca/L=Bogota/O=CINEP/CN=apbd2.miong.org.co'
</pre><p>
        Copie la solicitud <code class="literal">apbd2.miong.org.co.csr</code> al
        servidor apbd1.miong.org.co y dejela en el directorio
        <code class="literal">/var/postgresql/data</code>
      </p><p>
        Y allí ejecute:
      </p><pre class="programlisting">
    doas su - 
    cd /var/postgresql/data
    openssl x509 -req -days 3650 -in apbd2.miong.org.co.csr -CA root.crt -CAkey server.key -out apbd2.miong.org.co.crt -CAcreateserial
</pre><p>
        A continuación copie el certificado generado
        (<code class="literal">apbd2.miong.org.co.crt</code>) al computador
        cliente donde se usará:
      </p><pre class="programlisting">
    scp apbd2.miong.org.co.crt apbd2.miong.org.co:~/ssl/
</pre></div><div class="sect3" lang="es"><div class="titlepage"><div><div><h4 class="title"><a name="uso-de-los-certificados"></a>6.5.4. Uso de los certificados</h4></div></div></div><div class="sect4" lang="es"><div class="titlepage"><div><div><h5 class="title"><a name="caso-postgresql"></a>6.5.4.1. Caso PostgreSQL</h5></div></div></div><p>
          En el servidor edite el archivo
          <code class="literal">/var/postgresql/data/pg_hba.conf</code> y
          asegurese de agregar una línea para el usuario y el computador
          cliente: hostssl all usuario 192.168.100.11/32 cert
          clientcert=1
        </p><p>
          Reinicie PostgreSQL.
        </p><pre class="programlisting">
    doas sh /etc/rc.d/postgresql -d restart
</pre><p>
          Desde el cliente ejecute:
        </p><pre class="programlisting">
    doas chmod 0600 /home/usis/.postgresql/usuario.key
</pre><p>
          y pruebe la conexión asegurando que se usa el certificado del
          usuario respectivo:
        </p><pre class="programlisting">
    PGSSLCERT=/home/usis/.postgresql/usuario.crt \
    PGSSLKEY=/home/usis/.postgresql/usuario.key \
    psql -h192.168.100.21 -Uusuario usuario
</pre><p>
          Configure la aplicación para que en cada arranque o uso
          establezca:
        </p><pre class="programlisting">
    PGSSLCERT=/home/usis/.postgresql/usuario.crt 
    PGSSLKEY=/home/usis/.postgresql/usuario.key
</pre></div><div class="sect4" lang="es"><div class="titlepage"><div><div><h5 class="title"><a name="caso-ldapd"></a>6.5.4.2. Caso LDAPD</h5></div></div></div><p>
          Ubique el ceritifcado y llave en
          <code class="literal">/etc/ldad/certs/</code> del servidor donde corre
          ldapd:
        </p><pre class="programlisting">
    doas cp apbd2.miong.org.co.{key,crt} /etc/ldap/certs/
</pre><p>
          Configure <code class="literal">/etc/ldapd.conf</code>
        </p><pre class="programlisting">
    listen on $if1 tls certificate apbd2.miong.org.co
</pre><p>
          En los computadores que realicen conexiones al LDAP asegurese
          de agregar la llave de la entidad certificadora
          <code class="literal">/var/postgresql/data/root.crt</code>, es decir en
          el servidor apbd1 ejecute:
        </p><pre class="programlisting">
    cd /var/postgresql/data
    openssl x509 -noout -text -in root.crt &gt; root-paracerts
</pre><p>
          Copie el archivo <code class="literal">root-paracerts</code> en el
          cliente y agregue ese archivo al final de
          <code class="literal">/etc/ssl/cert.pem</code>
        </p></div></div><div class="sect3" lang="es"><div class="titlepage"><div><div><h4 class="title"><a name="referencias"></a>6.5.5. Referencias</h4></div></div></div><div class="itemizedlist"><ul type="disc" compact><li><p>
            <a href="https://www.howtoforge.com/postgresql-ssl-certificates" target="_top">https://www.howtoforge.com/postgresql-ssl-certificates</a>
          </p></li></ul></div></div></div><div class="footnotes"><br><hr width="100" align="left"><div class="footnote"><p xmlns="http://www.w3.org/TR/xhtml1/transitional"><sup>[<a name="ftn.idm44863568" href="#idm44863568">29</a>] </sup>
            Note que de esta forma puede cambiar la clave de otros
            usuarios de PostgreSQL.
          </p></div><div class="footnote"><p xmlns="http://www.w3.org/TR/xhtml1/transitional"><sup>[<a name="ftn.idm382510160" href="#idm382510160">30</a>] </sup>
          Si emplea un adJ 5.2 y planea conectarse desde clientes
          digamos en Ubuntu reciente requerirá el parche descrito en
          <a xmlns="" href="http://openbsd.7691.n7.nabble.com/ldapd-and-quot-The-Diffie-Hellman-prime-sent-by-the-server-is-not-acceptable-quot-td59635.html" target="_top">http://openbsd.7691.n7.nabble.com/ldapd-and-quot-The-Diffie-Hellman-prime-sent-by-the-server-is-not-acceptable-quot-td59635.html</a>
        </p></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="protocolos_de_soporte_y_de_usuario.html">Anterior</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="novedades.html">Siguiente</a></td></tr><tr><td width="40%" align="left" valign="top">5. Protocolos de soporte y de usuario </td><td width="20%" align="center"><a accesskey="h" href="index.html">Inicio</a></td><td width="40%" align="right" valign="top"> A. Novedades</td></tr></table></div></body></html>
